<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div id="navbar"></div>

<script>
  fetch('/navbar.html')
    .then(res => res.text())
    .then(html => { document.getElementById('navbar').innerHTML = html; setupNavbar(); });
</script>

<script>
  // API base selector: when running on localhost use relative paths, otherwise point to deployed backend
  const BACKEND_URL = 'https://a6cars-backend.onrender.com'; // change to your Render backend URL if different
  function api(path) {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return path;
    return BACKEND_URL + path;
  }
</script>

<script>
function setupNavbar(){
  try{
    const logoutBtn = document.getElementById('nav-logout');
  if(logoutBtn) logoutBtn.onclick = ()=>{ sessionStorage.removeItem('adminLoggedIn'); window.location.href='/signup.html'; };
    const adminLink = document.getElementById('nav-admin');
    // show admin link and hide book/history when admin present
    const isAdmin = !!sessionStorage.getItem('adminLoggedIn');
  if(isAdmin){ if(adminLink) adminLink.style.display='inline'; document.getElementById('nav-book').style.display='none'; document.getElementById('nav-history').style.display='none'; document.getElementById('nav-home').style.display='none'; }
    else { if(adminLink) adminLink.style.display='none'; }
  }catch(e){}
}

// If admin session already exists (sessionStorage), show the dashboard immediately
document.addEventListener('DOMContentLoaded', () => {
  try {
    const token = sessionStorage.getItem('adminToken');
    const isAdmin = sessionStorage.getItem('adminLoggedIn');
    if (isAdmin && token) {
      window.adminToken = token;
      document.getElementById('admin-login').classList.add('hidden');
      document.getElementById('admin-dashboard').classList.remove('hidden');
      // show all panels collapsed by default
      loadTransactions();
    }
  } catch(e){}
});
setTimeout(setupNavbar,120);
</script>

<!-- debug handlers removed for production UI -->
<script>
  // prevent direct access to admin dashboard without entering credentials on this page
  try { localStorage.removeItem('adminToken'); } catch(e){}
</script>
<!-- spacer for fixed navbar -->
<div class="h-20"></div>

<!-- NEW: Modern admin layout: sidebar + content -->
<div class="min-h-[70vh] flex bg-gray-100">
  <!-- Sidebar -->
  <aside class="w-72 bg-white shadow-md px-4 py-6">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 bg-blue-600 text-white flex items-center justify-center rounded">A6</div>
      <div>
        <div class="font-bold text-lg">A6 Admin</div>
        <div class="text-sm text-gray-500">Control Panel</div>
      </div>
    </div>
    <nav class="space-y-2">
      <button id="menu-add" class="w-full text-left px-3 py-2 rounded hover:bg-blue-50">Add Cars</button>
      <button id="menu-carmanage" class="w-full text-left px-3 py-2 rounded hover:bg-blue-50">Manage Cars</button>
      <button id="menu-verify" class="w-full text-left px-3 py-2 rounded hover:bg-blue-50">Verify Payment</button>
      <button id="menu-trans" class="w-full text-left px-3 py-2 rounded hover:bg-blue-50">Business Details</button>
      <button id="menu-all" class="w-full text-left px-3 py-2 rounded hover:bg-blue-50">Show All</button>
    </nav>

    <div class="mt-6 border-t pt-4">
      <div class="text-sm text-gray-600 mb-2">Filters</div>
      <input id="admin-search" placeholder="Search" class="w-full border px-2 py-1 rounded mb-2" />
      <div class="flex gap-2 mb-2">
        <input id="filter-start" type="date" class="border px-2 py-1 rounded w-1/2" />
        <input id="filter-end" type="date" class="border px-2 py-1 rounded w-1/2" />
      </div>
      <div class="flex gap-2">
        <button id="btn-apply-filters" class="flex-1 bg-green-600 text-white px-3 py-1 rounded">Apply</button>
        <button id="btn-clear-filters" class="flex-1 bg-gray-200 px-3 py-1 rounded">Clear</button>
      </div>

      <div class="mt-6">
        <button id="admin-logout" class="w-full bg-red-600 text-white px-3 py-2 rounded">Logout</button>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main class="flex-1 p-6">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold">Admin Panel</h1>
          <p class="text-sm text-gray-500">Overview and management tools</p>
        </div>
        <div class="text-right text-sm text-gray-500">Welcome, Admin</div>
      </div>

      <!-- Login box (keeps same ID) -->
      <div id="admin-login" class="space-y-4 max-w-md mx-auto">
        <input id="admin-id" type="text" placeholder="Admin ID" class="w-full p-3 border rounded" value="">
        <input id="admin-pass" type="password" placeholder="Password" class="w-full p-3 border rounded" value="">
        <div class="flex gap-2 items-center">
          <button id="admin-login-btn" type="button" class="bg-green-600 text-white px-4 py-2 rounded">Login</button>
          <div id="admin-login-msg" class="text-sm text-red-600"></div>
        </div>
      </div>

      <!-- Dashboard area (keeps same ID) -->
      <div id="admin-dashboard" class="hidden mt-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="p-4 bg-gradient-to-r from-blue-50 to-white rounded-lg shadow-sm">
            <div class="text-sm text-gray-500">Total Bookings</div>
            <div id="stat-bookings" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-4 bg-gradient-to-r from-green-50 to-white rounded-lg shadow-sm">
            <div class="text-sm text-gray-500">Pending Payments</div>
            <div id="stat-pending" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-4 bg-gradient-to-r from-yellow-50 to-white rounded-lg shadow-sm">
            <div class="text-sm text-gray-500">Available Cars</div>
            <div id="stat-cars" class="text-2xl font-bold">—</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div id="col-addcar" class="p-4 border rounded hidden bg-white">
            <h3 class="text-lg font-semibold mb-3">Add Car</h3>
            <form id="addCarForm" class="space-y-3">
              <input type="text" name="brand" placeholder="Brand" required class="w-full p-2 border rounded">
              <input type="text" name="model" placeholder="Model" required class="w-full p-2 border rounded">
              <input type="number" name="year" placeholder="Year" required class="w-full p-2 border rounded">
              <input type="number" step="0.01" name="daily_rate" placeholder="Daily Rate (INR)" required class="w-full p-2 border rounded">
              <input type="text" name="location" placeholder="Location" required class="w-full p-2 border rounded">
              <button type="submit" class="bg-blue-600 text-white w-full p-2 rounded">Add Car</button>
            </form>
          </div>

          <div id="col-carmanage" class="p-4 border rounded hidden bg-white lg:col-span-2">
            <h3 class="text-lg font-semibold mb-3">Manage Cars</h3>
            <div id="car-list" class="space-y-3"></div>
            <div id="car-bookings-panel" class="hidden mt-4 bg-gray-50 p-3 rounded">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium">Bookings for <span id="car-bookings-title"></span></h4>
                <button id="close-car-bookings" class="text-sm bg-gray-200 px-2 py-1 rounded">Close</button>
              </div>
              <div class="overflow-auto">
                <table class="w-full text-left border-collapse text-sm">
                  <thead><tr><th class="border px-2 py-1">Booking ID</th><th class="border px-2 py-1">Customer</th><th class="border px-2 py-1">From</th><th class="border px-2 py-1">To</th><th class="border px-2 py-1">Amount</th><th class="border px-2 py-1">Paid</th><th class="border px-2 py-1">Verified</th></tr></thead>
                  <tbody id="car-bookings-body"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="col-verify" class="p-4 border rounded hidden bg-white">
            <h3 class="text-lg font-semibold mb-3">Verify Payment</h3>
            <div id="qr-verify" class="mb-4"><div id="qr-result" class="mt-4 text-sm"></div></div>
            <div id="scanner" class="mt-4">
              <h4 class="font-medium mb-2">Scan with Camera</h4>
              <video id="video" width="100%" height="220" style="border:1px solid #ccc"></video>
              <div id="scan-status" class="text-sm mt-2"></div>
              <div class="mt-2">
                <button id="stop-scan" type="button" class="bg-red-600 text-white p-2 rounded">Stop Scan</button>
              </div>
            </div>
          </div>

          <div id="col-transactions" class="p-4 border rounded hidden bg-white lg:col-span-3">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">Transactions</h3>
              <div class="flex items-center gap-2">
                <button id="export-csv" type="button" class="bg-gray-700 text-white px-3 py-1 rounded">Export CSV</button>
              </div>
            </div>
            <div class="mt-3 overflow-auto">
              <table id="tx-table" class="w-full text-left border-collapse text-sm">
                <thead class="bg-gray-50"><tr><th class="border px-2 py-1">Payment ID</th><th class="border px-2 py-1">Customer</th><th class="border px-2 py-1">Car</th><th class="border px-2 py-1">From</th><th class="border px-2 py-1">To</th><th class="border px-2 py-1">Amount</th><th class="border px-2 py-1">Paid</th><th class="border px-2 py-1">Verified</th></tr></thead>
                <tbody id="tx-body"></tbody>
              </table>
            </div>
            <div class="mt-3 flex items-center gap-2">
              <button id="prev-page" type="button" class="px-2 py-1 bg-gray-200 rounded">Prev</button>
              <span id="page-info">Page 1</span>
              <button id="next-page" type="button" class="px-2 py-1 bg-gray-200 rounded">Next</button>
              <select id="page-size" class="border px-2 py-1 rounded">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
document.getElementById('addCarForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());

  // Admin endpoint requires authorization and the server route is /api/admin/addcar
  fetch(api('/api/admin/addcar'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAdminToken() },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    this.reset();
  });
});
// paging state needs to be declared early to avoid TDZ when loadTransactions is called
var currentPage = 1;
var currentPageSize = 20;

// Admin login handling (client-side)
// ensure adminToken is not auto-restored — admin must login each session
try { localStorage.removeItem('adminToken'); } catch(e){}

document.getElementById('admin-login-btn').addEventListener('click', function() {
  const id = document.getElementById('admin-id').value;
  const pass = document.getElementById('admin-pass').value;
  const msg = document.getElementById('admin-login-msg');
    fetch(api('/api/admin/login'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    // server expects `email` and `password` — send `email` instead of `id`
    body: JSON.stringify({ email: id, password: pass })
  }).then(async res => {
    // Read body as text then parse if possible to avoid json parse errors on empty responses
    const txt = await res.text();
    let j = {};
    try { j = txt ? JSON.parse(txt) : {}; } catch(e) { /* non-json body */ }
    if (!res.ok) throw new Error(j.message || txt || 'Login failed');
    return j;
  }).then((j) => {
  // store token in sessionStorage for this browser session and keep admin on this page
    window.adminToken = j.token;
    try { sessionStorage.setItem('adminLoggedIn', '1'); sessionStorage.setItem('adminToken', j.token); } catch(e){}
    msg.innerText = '';
    // show dashboard in-place (do not redirect) so token remains available for subsequent API calls
    document.getElementById('admin-login').classList.add('hidden');
    document.getElementById('admin-dashboard').classList.remove('hidden');
    // start loading data
    loadTransactions();
  // scanner will start only when admin opens the Verify panel
  console.debug('Admin logged in; scanner will start on Verify panel open');
  }).catch(err => {
    msg.innerText = err.message || 'Invalid admin ID or password.';
  });
});

// logout
document.getElementById('admin-logout').addEventListener('click', () => {
  // stop camera if running
  try{ stopScan(); }catch(e){}
  // clear token state
  window.adminToken = null;
  try { sessionStorage.removeItem('adminToken'); } catch(e){}
  try { localStorage.removeItem('adminToken'); } catch(e){}
  try { sessionStorage.removeItem('adminLoggedIn'); } catch(e){}
  // reset UI to login view and hide dashboard panels
  document.getElementById('admin-login').classList.remove('hidden');
  document.getElementById('admin-dashboard').classList.add('hidden');
  ['col-addcar','col-verify','col-transactions'].forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.add('hidden'); });
  // clear filters and reset page info
  try { document.getElementById('admin-search').value=''; document.getElementById('filter-start').value=''; document.getElementById('filter-end').value=''; } catch(e){}
  try { document.getElementById('page-info').innerText = 'Page 1 / 1'; } catch(e){}
  // redirect back to signup landing
  try { window.location.href = '/signup.html'; } catch(e){}
});

// helper to get a trimmed admin token from either window or localStorage
function getAdminToken(){
  try{ return (window.adminToken || sessionStorage.getItem('adminToken') || localStorage.getItem('adminToken') || '').toString().trim(); }catch(e){ return ''; }
  }


function buildFiltersQuery(params={}){
  const q = document.getElementById('admin-search').value.trim();
  const start = document.getElementById('filter-start').value;
  const end = document.getElementById('filter-end').value;
  if (q) params.q = q;
  if (start) params.start_date = start;
  if (end) params.end_date = end;
  return Object.keys(params).map(k=>encodeURIComponent(k)+'='+encodeURIComponent(params[k])).join('&');
}

function loadTransactions(page=1,pageSize=20) {
  currentPage = page;
  currentPageSize = pageSize;
  const token = getAdminToken();
  // if no token, show login and don't call protected endpoint
  if (!token) {
    try { document.getElementById('admin-login').classList.remove('hidden'); document.getElementById('admin-dashboard').classList.add('hidden'); } catch(e){}
    return Promise.resolve({ page:1, pageSize:20, total:0, data: [] });
  }
  const qStr = buildFiltersQuery({ page, pageSize });
  return fetch(api(`/api/admin/transactions?${qStr}`), { headers: { 'Authorization': 'Bearer ' + token } }).then(r => {
    if (r.status === 401) {
      // invalid token - clear and force login flow
      try{ sessionStorage.removeItem('adminToken'); sessionStorage.removeItem('adminLoggedIn'); localStorage.removeItem('adminToken'); }catch(e){}
      window.adminToken = null;
      try{ document.getElementById('admin-login').classList.remove('hidden'); document.getElementById('admin-dashboard').classList.add('hidden'); }catch(e){}
      return Promise.resolve({ page:1, pageSize:20, total:0, data: [] });
    }
    return r.json();
  }).then(resp => {
    const list = resp.data || [];
    const body = document.getElementById('tx-body');
    body.innerHTML = '';
    (list || []).forEach(tx => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="border px-2 py-1">${tx.payment_id}</td><td class="border px-2 py-1">${tx.name} (${tx.email})</td><td class="border px-2 py-1">${tx.brand} ${tx.model}</td><td class="border px-2 py-1">${(new Date(tx.start_date)).toLocaleDateString()}</td><td class="border px-2 py-1">${(new Date(tx.end_date)).toLocaleDateString()}</td><td class="border px-2 py-1">₹${tx.amount}</td><td class="border px-2 py-1">${tx.paid==1?'Yes':'No'}</td><td class="border px-2 py-1">${tx.verified==1?'Yes':'No'}</td>`;
      body.appendChild(tr);
    });
    document.getElementById('page-info').innerText = `Page ${resp.page} / ${Math.max(1, Math.ceil((resp.total||0)/resp.pageSize))}`;
    // populate dashboard stats
    try { loadStats(); } catch(e){}
    // update stats from transactions response
    try {
      // total payments/bookings
      const statB = document.getElementById('stat-bookings'); if (statB) statB.innerText = resp.total || 0;
      // count pending payments on this page (best-effort); fetch a larger page for accurate pending count via loadStats
      const pendingOnPage = (resp.data || []).filter(p => p.paid==0).length;
      const statP = document.getElementById('stat-pending'); if (statP) statP.innerText = pendingOnPage;
  // refresh cars count
  fetch(api('/api/cars'), { headers: { 'Authorization': 'Bearer ' + token } }).then(r2 => r2.json()).then(cars => { const statC = document.getElementById('stat-cars'); if (statC) statC.innerText = (Array.isArray(cars)?cars.length:0); }).catch(()=>{});
    } catch(e){}
  }).catch(()=>{});
}

// Load dashboard stats: total bookings, pending payments, available cars
function loadStats(){
  const token = getAdminToken();
  if (!token) return;
  // fetch a large page size to approximate pending payments; fallback to separate queries if needed
  fetch(api('/api/admin/transactions?page=1&pageSize=1000'), { headers: { 'Authorization': 'Bearer ' + token } })
    .then(r => { if (!r.ok) throw new Error('Unauthorized'); return r.json(); })
    .then(j => {
      const total = j.total || (Array.isArray(j.data)? j.data.length : 0);
      const pending = (j.data || []).filter(p => p.paid==0).length;
      const statB = document.getElementById('stat-bookings'); if (statB) statB.innerText = total;
      const statP = document.getElementById('stat-pending'); if (statP) statP.innerText = pending;
    }).catch(()=>{
      // ignore
    });

  fetch(api('/api/cars'), { headers: { 'Authorization': 'Bearer ' + token } }).then(r => r.json()).then(cars => {
    const statC = document.getElementById('stat-cars'); if (statC) statC.innerText = (Array.isArray(cars)?cars.length:0);
  }).catch(()=>{});
}

// pagination controls
document.getElementById('prev-page').addEventListener('click', () => { if (currentPage>1) loadTransactions(currentPage-1, currentPageSize); });
document.getElementById('next-page').addEventListener('click', () => { loadTransactions(currentPage+1, currentPageSize); });
document.getElementById('page-size').addEventListener('change', (e) => { loadTransactions(1, parseInt(e.target.value)); });

document.getElementById('btn-apply-filters').addEventListener('click', () => { loadTransactions(1, currentPageSize); });
document.getElementById('btn-clear-filters').addEventListener('click', () => { document.getElementById('admin-search').value=''; document.getElementById('filter-start').value=''; document.getElementById('filter-end').value=''; loadTransactions(1, currentPageSize); });

// Camera-based QR scanning (uses browser MediaDevices + a lightweight JS QR library if available).
// Camera access is requested only when admin opens the Verify panel. Use stopScan() to stop and release camera.
let videoStream = null;
function stopScan(){
  try{
    const video = document.getElementById('video');
    if (videoStream) {
      videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
    }
    if (video) {
      try{ video.pause(); } catch(e){}
      try{ video.srcObject = null; } catch(e){}
    }
    const status = document.getElementById('scan-status'); if (status) status.innerText = 'Stopped';
  }catch(e){}
}

document.getElementById('stop-scan').addEventListener('click', () => stopScan());

async function startScan() {
  const video = document.getElementById('video');
  document.getElementById('scan-status').innerText = 'Starting camera...';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    videoStream = stream;
    video.play();
    document.getElementById('scan-status').innerText = 'Scanning...';

    // Use BarcodeDetector if available (supported in some browsers)
    if (window.BarcodeDetector) {
      const detector = new BarcodeDetector({formats: ['qr_code']});
      const scanLoop = async () => {
        try {
          const faces = await detector.detect(video);
          if (faces && faces.length) {
            const token = faces[0].rawValue;
            videoStream.getTracks().forEach(t => t.stop());
            videoStream = null;
            document.getElementById('scan-status').innerText = 'Found token';
            // call verify endpoint with auth
            fetch(api('/api/admin/verify-qr'), { method: 'POST', headers: {'Content-Type':'application/json','Authorization':'Bearer ' + window.adminToken}, body: JSON.stringify({ qr_token: token }) }).then(r => r.json()).then(j => {
              const result = document.getElementById('qr-result');
              if (j.booking) {
                result.innerText = `Verified! Booking ID: ${j.booking.id} (${j.booking.start_date} - ${j.booking.end_date})\nCar: ${j.car.brand} ${j.car.model}\nCustomer: ${j.customer.name} (${j.customer.email})\nAmount: ₹${j.amount}`;
                loadTransactions();
              } else {
                result.innerText = j.message || 'Not found';
              }
            }).catch(()=>{ document.getElementById('qr-result').innerText = 'Verify failed'; });
            return;
          }
        } catch (e) {}
        requestAnimationFrame(scanLoop);
      };
      requestAnimationFrame(scanLoop);
    } else {
      document.getElementById('scan-status').innerText = 'Camera started — please pause and paste token if automatic scanning not supported.';
    }
  } catch (e) {
    document.getElementById('scan-status').innerText = 'Camera start failed';
  }
}

// Do not auto-start camera on hover; camera will be requested explicitly when Verify panel is opened.

// Menu interactions: scroll into view and toggle active state
function setActiveMenu(id) {
  ['menu-add','menu-verify','menu-trans','menu-all'].forEach(k => {
    const el = document.getElementById(k);
    if (!el) return;
    if (k === id) {
      el.classList.remove('bg-gray-100'); el.classList.add('bg-blue-100'); el.classList.add('text-blue-800');
    } else {
      el.classList.remove('bg-blue-100'); el.classList.remove('text-blue-800'); el.classList.add('bg-gray-100'); el.classList.remove('text-gray-800');
    }
  });
}


function showOnly(idToShow) {
  ['col-addcar','col-verify','col-transactions','col-carmanage'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    if (id === idToShow) el.classList.remove('hidden'); else el.classList.add('hidden');
  });
  // if verify panel is not shown, ensure camera is stopped and released
  try { if (idToShow !== 'col-verify') stopScan(); } catch(e){}
}


// (Removed dynamic small 'Manage Cars' button insertion — using sidebar button)

// safe event listener attachments
const safeOn = (id, fn) => { const el = document.getElementById(id); if (el) el.addEventListener('click', fn); };
safeOn('menu-add', () => { showOnly('col-addcar'); const c = document.getElementById('col-addcar'); if (c) c.scrollIntoView({behavior:'smooth'}); setActiveMenu('menu-add'); });
safeOn('menu-verify', () => { showOnly('col-verify'); const c = document.getElementById('col-verify'); if (c) c.scrollIntoView({behavior:'smooth'}); setActiveMenu('menu-verify'); setTimeout(()=>{ if (typeof videoStream === 'undefined' || !videoStream) startScan(); }, 100); });
safeOn('menu-trans', () => { showOnly('col-transactions'); const c = document.getElementById('col-transactions'); if (c) c.scrollIntoView({behavior:'smooth'}); setActiveMenu('menu-trans'); loadTransactions(1,currentPageSize); });
safeOn('menu-all', () => { ['col-addcar','col-verify','col-transactions','col-carmanage'].forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }); const dash = document.getElementById('admin-dashboard'); if (dash) dash.scrollIntoView({behavior:'smooth'}); setActiveMenu('menu-all'); loadTransactions(1,currentPageSize); });
safeOn('menu-carmanage', () => { showOnly('col-carmanage'); const c = document.getElementById('col-carmanage'); if (c) c.scrollIntoView({behavior:'smooth'}); setActiveMenu('menu-carmanage'); loadCarList(); });

document.getElementById('export-csv').addEventListener('click', () => {
  const token = getAdminToken();
  const qStr = buildFiltersQuery();
  const url = api(`/api/admin/transactions.csv${qStr?('?'+qStr):''}`);
  fetch(url, { headers: { 'Authorization': 'Bearer ' + token } }).then(r => {
    if (r.status === 401) throw new Error('Unauthorized');
    if (!r.ok) throw new Error('Export failed');
    return r.blob();
  }).then(b => {
    const url = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = url; a.download = 'transactions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }).catch(()=> alert('Export failed'));
});

// jsQR fallback loader
const jsQrScript = document.createElement('script');
jsQrScript.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js';
// Car management logic
function loadCarList() {
  const token = getAdminToken();
  if (!token) return;
  fetch(api('/api/cars'), { headers: { 'Authorization': 'Bearer ' + token } })
    .then(r => r.json())
    .then(list => {
      const carListDiv = document.getElementById('car-list');
      carListDiv.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0) {
        carListDiv.innerHTML = '<div class="text-gray-500">No cars found.</div>';
        return;
      }
      list.forEach(car => {
        const carDiv = document.createElement('div');
        carDiv.className = 'border rounded p-3 mb-2 flex flex-col md:flex-row md:items-center justify-between';
        carDiv.innerHTML = `
          <div>
            <span class="font-semibold">${car.brand} ${car.model}</span> (${car.year})<br>
            Location: ${car.location} | Rate: ₹${car.daily_rate}/day
          </div>
          <div class="flex gap-2 mt-2 md:mt-0">
            <button class="bg-red-600 text-white px-3 py-1 rounded" data-carid="${car.id}" onclick="deleteCar(${car.id}, this)">Delete</button>
            <button class="bg-blue-600 text-white px-3 py-1 rounded" data-carid="${car.id}" onclick="viewCarBookings(${car.id}, '${car.brand} ${car.model}')">View Bookings</button>
          </div>
        `;
        carListDiv.appendChild(carDiv);
      });
    });
}

function deleteCar(carId, btn) {
  if (!confirm('Are you sure you want to delete this car? This will also delete all bookings for this car.')) return;
  const token = getAdminToken();
  btn.disabled = true;
  fetch(api('/api/deletecar'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ car_id: carId })
  })
    .then(r => r.json())
    .then(j => {
      alert(j.message || 'Car deleted');
      loadCarList();
    })
    .catch(()=>{ alert('Delete failed'); btn.disabled = false; });
}

function viewCarBookings(carId, carName) {
  const token = getAdminToken();
  const panel = document.getElementById('car-bookings-panel');
  const title = document.getElementById('car-bookings-title');
  const body = document.getElementById('car-bookings-body');
  title.innerText = carName;
  panel.classList.remove('hidden');
  body.innerHTML = '<tr><td colspan="7" class="text-gray-500">Loading...</td></tr>';
  fetch(api(`/api/car-bookings/${carId}`), { headers: { 'Authorization': 'Bearer ' + token } })
    .then(r => r.json())
    .then(list => {
      body.innerHTML = '';
      if (!Array.isArray(list) || list.length === 0) {
        body.innerHTML = '<tr><td colspan="7" class="text-gray-500">No bookings found.</td></tr>';
        return;
      }
      list.forEach(bk => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="border px-2 py-1">${bk.id}</td><td class="border px-2 py-1">${bk.name} (${bk.email})</td><td class="border px-2 py-1">${(new Date(bk.start_date)).toLocaleDateString()}</td><td class="border px-2 py-1">${(new Date(bk.end_date)).toLocaleDateString()}</td><td class="border px-2 py-1">₹${bk.amount}</td><td class="border px-2 py-1">${bk.paid==1?'Yes':'No'}</td><td class="border px-2 py-1">${bk.verified==1?'Yes':'No'}</td>`;
        body.appendChild(tr);
      });
    });
}

document.getElementById('close-car-bookings').addEventListener('click', () => {
  document.getElementById('car-bookings-panel').classList.add('hidden');
});
document.head.appendChild(jsQrScript);

// modify startScan to use jsQR if BarcodeDetector not available
const originalStartScan = startScan;
startScan = async function() {
  const video = document.getElementById('video');
  document.getElementById('scan-status').innerText = 'Starting camera...';
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    videoStream = stream;
    video.play();
    document.getElementById('scan-status').innerText = 'Scanning...';

    if (window.BarcodeDetector) {
      // keep original BarcodeDetector path
      const detector = new BarcodeDetector({formats: ['qr_code']});
      const scanLoop = async () => {
        try {
          const faces = await detector.detect(video);
          if (faces && faces.length) {
            const token = faces[0].rawValue;
            videoStream.getTracks().forEach(t => t.stop());
            videoStream = null;
            document.getElementById('scan-status').innerText = 'Found token';
            fetch('/api/admin/verify-qr', { method: 'POST', headers: {'Content-Type':'application/json','Authorization':'Bearer ' + getAdminToken()}, body: JSON.stringify({ qr_token: token }) }).then(r => r.json()).then(j => {
              const result = document.getElementById('qr-result');
              if (j.booking) {
                result.innerText = `Verified! Booking ID: ${j.booking.id} (${j.booking.start_date} - ${j.booking.end_date})\nCar: ${j.car.brand} ${j.car.model}\nCustomer: ${j.customer.name} (${j.customer.email})\nAmount: ₹${j.amount}`;
                loadTransactions();
              } else {
                result.innerText = j.message || 'Not found';
              }
            }).catch(()=>{ document.getElementById('qr-result').innerText = 'Verify failed'; });
            return;
          }
        } catch (e) {}
        requestAnimationFrame(scanLoop);
      };
      requestAnimationFrame(scanLoop);
    } else {
      // use jsQR fallback
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const scanLoop = () => {
        if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) { requestAnimationFrame(scanLoop); return; }
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        try {
          const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const code = window.jsQR(imgData.data, imgData.width, imgData.height);
          if (code && code.data) {
            videoStream.getTracks().forEach(t => t.stop());
            videoStream = null;
            document.getElementById('scan-status').innerText = 'Found token';
            fetch(api('/api/admin/verify-qr'), { method: 'POST', headers: {'Content-Type':'application/json','Authorization':'Bearer ' + getAdminToken()}, body: JSON.stringify({ qr_token: code.data }) }).then(r => r.json()).then(j => {
              const result = document.getElementById('qr-result');
              if (j.booking) {
                result.innerText = `Verified! Booking ID: ${j.booking.id} (${j.booking.start_date} - ${j.booking.end_date})\nCar: ${j.car.brand} ${j.car.model}\nCustomer: ${j.customer.name} (${j.customer.email})\nAmount: ₹${j.amount}`;
                loadTransactions();
              } else {
                result.innerText = j.message || 'Not found';
              }
            }).catch(()=>{ document.getElementById('qr-result').innerText = 'Verify failed'; });
            return;
          }
        } catch (e) {}
        requestAnimationFrame(scanLoop);
      };
      requestAnimationFrame(scanLoop);
    }
  } catch (e) {
    document.getElementById('scan-status').innerText = 'Camera start failed';
  }
};
</script>

</body>
</html>