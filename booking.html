<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book a Car | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-gray-100 p-6">

<!-- ✅ Navbar -->
<div id="navbar"></div>
<script>
  // Load navbar HTML file locally
  fetch('/navbar.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('navbar').innerHTML = html;
      setupNavbar();
    })
    .catch(() => console.error('Navbar load failed'));
</script>

<script>
function setupNavbar() {
  try {
    const logoutBtn = document.getElementById('nav-logout');
    if (logoutBtn) logoutBtn.onclick = () => {
      // clear full session on logout
      localStorage.removeItem('customer_id');
      localStorage.removeItem('customer_name');
      localStorage.removeItem('auth_token');
      sessionStorage.removeItem('adminLoggedIn');
      window.location.href = '/login.html';
    };

    const adminLink = document.getElementById('nav-admin');
    const isAdmin = !!sessionStorage.getItem('adminLoggedIn');
    if (isAdmin) {
      if (adminLink) adminLink.style.display = 'inline';
      document.getElementById('nav-book').style.display = 'none';
      document.getElementById('nav-history').style.display = 'none';
      document.getElementById('nav-home').style.display = 'none';
    } else {
      if (adminLink) adminLink.style.display = 'none';
    }

    const name = localStorage.getItem('customer_name');
    const user = document.getElementById('nav-user');
    if (name && user) {
      user.innerText = 'Hello, ' + name;
      user.classList.remove('hidden');
    }
  } catch (e) {}
}
setTimeout(setupNavbar, 120);
</script>

<!-- Spacer for fixed navbar -->
<div class="h-20"></div>

<!-- Title Section -->
<div class="flex justify-center">
  <div class="bg-white p-6 rounded shadow w-3/4 text-center">
    <h1 class="text-3xl font-bold text-blue-700 mb-2">Book Your Car</h1>
    <p class="text-gray-600 mb-4">Select a car and choose available dates</p>
  </div>
</div>

<!-- Cars Grid -->
<div id="cars" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<script>
const customer_id = localStorage.getItem('customer_id');
if (!customer_id) {
  window.location.href = '/login.html';
}

// ✅ Backend API URL
const BACKEND_URL = 'https://a6cars-backend.onrender.com';
function api(path) {
  if (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    return path;
  return BACKEND_URL + path;
}

// ✅ Fetch cars with bookings
fetch(api('/api/cars-with-bookings'), {
  headers: (() => {
    const t = localStorage.getItem('auth_token');
    return t ? { 'Authorization': 'Bearer ' + t } : {};
  })()
})
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById('cars');
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-600">No cars available at the moment.</p>';
      return;
    }

    data.forEach(car => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow text-center space-y-3';
      div.innerHTML = `
        <h2 class="text-2xl font-bold">${car.brand} ${car.model}</h2>
        <p>Year: ${car.year}</p>
        <p>Daily Rate: ₹${car.daily_rate}</p>
        <p>Location: ${car.location}</p>
        <label>Start Date: <input type="text" id="start-${car.id}" placeholder="dd/mm/yyyy" class="border rounded p-1"></label><br>
        <label>End Date: <input type="text" id="end-${car.id}" placeholder="dd/mm/yyyy" class="border rounded p-1"></label><br>
        <div id="booked-info-${car.id}" class="text-sm text-red-600 hidden"></div>
        <button id="book-btn-${car.id}" onclick="bookCar(${car.id})" class="bg-blue-600 text-white px-4 py-2 rounded mt-2">Book</button>
      `;
      container.appendChild(div);

      const bookings = car.booked_ranges || [];
      const info = document.getElementById(`booked-info-${car.id}`);
      info.dataset.bookings = JSON.stringify(bookings);

      const ranges = bookings.map(b => ({
        start: new Date(b.start_date),
        end: new Date(b.end_date)
      })).sort((a, b) => a.start - b.start);

      const disabledRanges = ranges.map(m => ({ from: m.start, to: m.end }));
      let fpEnd;

      const fpStart = flatpickr(document.getElementById(`start-${car.id}`), {
        dateFormat: 'd/m/Y',
        minDate: 'today',
        disable: disabledRanges,
        onChange: function(selectedDates) {
          if (selectedDates && selectedDates[0]) {
            const min = new Date(selectedDates[0].getTime());
            fpEnd.set('minDate', min);
          }
        }
      });

      fpEnd = flatpickr(document.getElementById(`end-${car.id}`), {
        dateFormat: 'd/m/Y',
        minDate: 'today',
        disable: disabledRanges,
        onChange: function(selectedDates) {
          if (selectedDates && selectedDates[0]) {
            fpStart.set('maxDate', selectedDates[0]);
          }
        }
      });
    });
  })
  .catch(err => {
    document.getElementById('cars').innerHTML = `<p class="text-center text-red-600">Error loading cars: ${err.message}</p>`;
  });

// ✅ Booking function
function bookCar(car_id) {
  const start = document.getElementById(`start-${car_id}`).value;
  const end = document.getElementById(`end-${car_id}`).value;

  if (!start || !end) {
    alert('Please select both start and end dates.');
    return;
  }

  const info = document.getElementById(`booked-info-${car_id}`);
  const bookings = info && info.dataset.bookings ? JSON.parse(info.dataset.bookings) : [];

  function parseDMY(str) {
    const parts = str.split('/');
    if (parts.length !== 3) return null;
    return new Date(parts[2], parts[1] - 1, parts[0]);
  }

  const s = parseDMY(start);
  const e = parseDMY(end);
  if (s > e) { alert('Start date must be before end date.'); return; }

  const overlaps = (aStart, aEnd, bStart, bEnd) => (aStart <= bEnd) && (bStart <= aEnd);
  for (const b of bookings) {
    const bS = new Date(b.start_date);
    const bE = new Date(b.end_date);
    if (overlaps(s, e, bS, bE)) {
      alert('Selected dates overlap with existing bookings. Please choose different dates.');
      return;
    }
  }

  const btn = document.getElementById(`book-btn-${car_id}`);
  btn.disabled = true;
  btn.innerText = 'Booking...';

  fetch(api('/api/book'), {
    method: 'POST',
    headers: Object.assign({ 'Content-Type': 'application/json' }, (localStorage.getItem('auth_token') ? { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') } : {})),
    body: JSON.stringify({
      car_id,
      customer_id,
      start_date: `${start.split('/').reverse().join('-')}`,
      end_date: `${end.split('/').reverse().join('-')}`
    })
  })
  .then(res => res.json())
  .then(data => {
    btn.disabled = false;
    btn.innerText = 'Book';
    if (!data) { alert('Booking failed.'); return; }

    alert(data.message || 'Booking completed successfully!');
    window.location.href = '/history.html';
  })
  .catch(err => {
    btn.disabled = false;
    btn.innerText = 'Book';
    alert('Booking failed: ' + (err.message || 'Network error'));
  });
}
</script>

</body>
</html>
