<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book a Car | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- flatpickr for rich date picking -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-gray-100 p-6">

<div id="navbar"></div>

<script>
  fetch('/navbar.html')
    .then(res => res.text())
    .then(html => { document.getElementById('navbar').innerHTML = html; setupNavbar(); });
</script>

<script>
function setupNavbar(){
  try{
    const logoutBtn = document.getElementById('nav-logout');
  if(logoutBtn) logoutBtn.onclick = ()=>{ localStorage.removeItem('customer_id'); window.location.href='/signup.html'; };
    const adminLink = document.getElementById('nav-admin');
    const isAdmin = !!sessionStorage.getItem('adminLoggedIn');
  if(isAdmin){ if(adminLink) adminLink.style.display='inline'; document.getElementById('nav-book').style.display='none'; document.getElementById('nav-history').style.display='none'; document.getElementById('nav-home').style.display='none'; }
    else { if(adminLink) adminLink.style.display='none'; }
    try { const name = localStorage.getItem('customer_name'); const user = document.getElementById('nav-user'); if (name && user) { user.innerText = 'Hello, ' + name; user.classList.remove('hidden'); } } catch(e){}
  }catch(e){}
}
setTimeout(setupNavbar,120);
</script>

<!-- spacer for fixed navbar -->
<div class="h-20"></div>

<div class="flex justify-center">
  <div class="bg-white p-6 rounded shadow w-3/4 text-center">
    <h1 class="text-3xl font-bold text-blue-700 mb-2">Book Your Car</h1>
    <p class="text-gray-600 mb-4">Select a car and choose available dates</p>
  </div>
</div>

<div id="cars" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  <!-- Cars list will appear here -->
</div>

<script>
const customer_id = localStorage.getItem('customer_id');
if (!customer_id) {
  window.location.href = '/login.html';
}

// Fetch available cars with merged bookings
fetch('/api/cars-with-bookings')
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById('cars');
    data.forEach(car => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow text-center space-y-3';
      div.innerHTML = `
        <h2 class="text-2xl font-bold">${car.brand} ${car.model}</h2>
        <p>Year: ${car.year}</p>
        <p>Daily Rate: ₹${car.daily_rate}</p>
        <p>Location: ${car.location}</p>
        <label>Start Date: <input type="text" id="start-${car.id}" placeholder="dd/mm/yyyy" class="border rounded p-1"></label><br>
        <label>End Date: <input type="text" id="end-${car.id}" placeholder="dd/mm/yyyy" class="border rounded p-1"></label><br>
        <div id="booked-info-${car.id}" class="text-sm text-red-600 hidden"></div>
        <button id="book-btn-${car.id}" onclick="bookCar(${car.id})" class="bg-blue-600 text-white px-4 py-2 rounded mt-2">Book</button>
      `;
      container.appendChild(div);

      // use merged booked ranges returned by server
      const bookings = car.booked_ranges || [];
      const info = document.getElementById(`booked-info-${car.id}`);
      info.dataset.bookings = JSON.stringify(bookings || []);

      const ranges = (bookings || []).map(b => ({ start: new Date(b.start_date), end: new Date(b.end_date) })).sort((a,b) => a.start - b.start);
      const disabledRanges = ranges.map(m => ({ from: m.start, to: m.end }));
      let fpEnd;
  const fpStart = flatpickr(document.getElementById(`start-${car.id}`), { dateFormat: 'd/m/Y', minDate: 'today', disable: disabledRanges, onChange: function(selectedDates) { if (selectedDates && selectedDates[0]) { const min = new Date(selectedDates[0].getTime()); fpEnd.set('minDate', min); } } });
  fpEnd = flatpickr(document.getElementById(`end-${car.id}`), { dateFormat: 'd/m/Y', minDate: 'today', disable: disabledRanges, onChange: function(selectedDates) { if (selectedDates && selectedDates[0]) { fpStart.set('maxDate', selectedDates[0]); } } });
    });
  });

function bookCar(car_id) {
  const start = document.getElementById(`start-${car_id}`).value;
  const end = document.getElementById(`end-${car_id}`).value;

  if (!start || !end) {
    alert('Please select both start and end dates.');
    return;
  }

  // Check against existing bookings fetched earlier
  const info = document.getElementById(`booked-info-${car_id}`);
  const bookings = info && info.dataset.bookings ? JSON.parse(info.dataset.bookings) : [];
  // start/end are in dd/mm/yyyy from flatpickr; convert to Date objects
  function parseDMY(str) {
    const parts = str.split('/');
    if (parts.length !== 3) return null;
    const d = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10) - 1;
    const y = parseInt(parts[2], 10);
    return new Date(y, m, d);
  }
  const s = parseDMY(start);
  const e = parseDMY(end);
  if (s > e) { alert('Start date must be before end date.'); return; }

  // helper to check overlap
  const overlaps = (aStart, aEnd, bStart, bEnd) => {
    return (aStart <= bEnd) && (bStart <= aEnd);
  };

  for (const b of bookings) {
    const bS = new Date(b.start_date);
    const bE = new Date(b.end_date);
    if (overlaps(s, e, bS, bE)) {
      alert('Selected dates overlap with existing bookings. Please choose different dates.');
      return;
    }
  }

  fetch('/api/book', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      car_id,
      customer_id,
      // convert dd/mm/yyyy to yyyy-mm-dd for server
      start_date: (function(d){const p=d.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`})(start),
      end_date: (function(d){const p=d.split('/'); return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`})(end)
    })
  })
  .then(res => res.json())
  .then(data => {
    // show bill if returned
      if (data && data.bill && data.payment_id) {
      const bill = data.bill;
      const txt = `Booking successful!\nDays: ${bill.days}\nDaily Rate: ₹${bill.daily_rate}\nSubtotal: ₹${bill.subtotal}\nDiscount: ₹${bill.discount}\nTotal: ₹${bill.total}`;
      // Build merchant UPI payment QR (customer scans this to pay)
  const upi = `upi://pay?pa=8179134484@pthdfc&pn=${encodeURIComponent('A6 Cars')}&am=${bill.total}`;
      const upiQrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(upi);

      // open a small modal with QR image, download link, and `I paid` button
      const modalHtml = `
        <div style="font-family: Arial, sans-serif; padding:20px; text-align:center;">
          <h3>Pay ₹${bill.total}</h3>
          <p>Please scan this UPI QR to pay the exact amount.</p>
          <img src="${upiQrUrl}" alt="UPI QR" style="width:220px;height:220px;" />
          <div style="margin-top:12px;"><a id="download-qr" href="${upiQrUrl}" download="payment-qr.png" class="bg-gray-200 p-2 rounded border">Download QR</a></div>
          <div style="margin-top:12px;">
            <button id="paid-btn" style="background:#16a34a;color:#fff;padding:8px 12px;border-radius:6px;border:none;margin-right:8px;">I Paid</button>
            <button id="cancel-pay" style="background:#ef4444;color:#fff;padding:8px 12px;border-radius:6px;border:none;">Cancel</button>
          </div>
        </div>
      `;
      const w = window.open('', '_blank', 'width=420,height=640');
      if (!w) {
        alert(txt + '\n\nCannot open payment window — please allow popups.\nPayment QR link: ' + upiQrUrl);
        window.location.href = '/history.html';
        return;
      }
  w.document.title = 'Pay Now - A6 Cars';
      w.document.body.innerHTML = modalHtml;
      // wire buttons
      w.document.getElementById('paid-btn').addEventListener('click', function() {
        // customer confirms they've paid; call server to mark payment and generate verification QR
        fetch('/api/pay', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ payment_id: data.payment_id }) })
          .then(r => r.json()).then(pj => {
            if (pj.qr_token) {
              const verUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(pj.qr_token);
              w.document.body.innerHTML = `<h3>Payment successful</h3><p>Show this QR at pickup for verification</p><img src="${verUrl}" alt="QR" style="width:220px;height:220px;" /><div style="margin-top:12px;"><a id="dl-verify" href="${verUrl}" download="verification-qr.png" class="bg-gray-200 p-2 rounded border">Download Verification QR</a></div>`;
              // automatically trigger download of verification QR in the popup
              try {
                const cid = localStorage.getItem('customer_id');
                const admin = sessionStorage.getItem('adminLoggedIn');
                if (admin) { window.location.href = '/admin.html'; }
                if (!cid && !admin) window.location.href = '/signup.html';
              } catch(e){}
              // remember last qr_token for customer (optional) so they can check status later
              try { localStorage.setItem('last_qr_token', pj.qr_token); } catch(e){}
              // close the popup shortly after and redirect to history
              setTimeout(() => { try { w.close(); } catch(e){}; window.location.href = '/history.html'; }, 2000);
            } else {
              alert('Payment failed');
            }
          }).catch(()=> alert('Payment failed'));
      });
      w.document.getElementById('cancel-pay').addEventListener('click', function() { w.close(); window.location.href = '/history.html'; });
    } else {
      alert(data.message);
      window.location.href = '/history.html';
    }
  });
}
</script>

</body>
</html>