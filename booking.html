<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book a Car | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-gray-100 p-6">

<!-- Navbar -->
<div id="navbar"></div>

<script>
  // ðŸ”§ Detect backend environment
  const BACKEND_URL =
    (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
      ? 'http://localhost:3000'
      : 'https://a6cars-backend.onrender.com';

  // Load navbar (optional if you have a navbar.html)
  fetch('/navbar.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('navbar').innerHTML = html;
      setupNavbar();
    });

  function setupNavbar() {
    try {
      const logoutBtn = document.getElementById('nav-logout');
      if (logoutBtn) logoutBtn.onclick = () => {
        localStorage.clear();
        window.location.href = '/login.html';
      };
    } catch (e) {}
  }
</script>

<div class="h-20"></div>

<!-- Title -->
<div class="flex justify-center">
  <div class="bg-white p-6 rounded shadow w-3/4 text-center">
    <h1 class="text-3xl font-bold text-blue-700 mb-2">Book Your Car</h1>
    <p class="text-gray-600 mb-4">Select a car and choose available dates</p>
  </div>
</div>

<!-- Cars Grid -->
<div id="cars" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

<script>
const customer_id = localStorage.getItem('customer_id');
if (!customer_id) window.location.href = '/login.html';

// âœ… Fetch available cars
fetch(`${BACKEND_URL}/api/cars`)
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById('cars');
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-600">No cars available.</p>';
      return;
    }

    data.forEach(car => {
      const div = document.createElement('div');
      div.className = 'bg-white p-6 rounded-lg shadow text-center space-y-3';
      div.innerHTML = `
        <h2 class="text-2xl font-bold">${car.brand} ${car.model}</h2>
        <p>Year: ${car.year}</p>
        <p>Rate: â‚¹${car.daily_rate}</p>
        <p>Location: ${car.location}</p>
        <label>Start Date: <input type="text" id="start-${car.id}" placeholder="dd/mm/yyyy" class="border rounded p-1"></label><br>
        <label>End Date: <input type="text" id="end-${car.id}" placeholder="dd/mm/yyyy" class="border rounded p-1"></label><br>
        <button id="book-btn-${car.id}" onclick="bookCar(${car.id})" class="bg-blue-600 text-white px-4 py-2 rounded mt-2">Book</button>
      `;
      container.appendChild(div);

      flatpickr(`#start-${car.id}`, { dateFormat: 'd/m/Y', minDate: 'today' });
      flatpickr(`#end-${car.id}`, { dateFormat: 'd/m/Y', minDate: 'today' });
    });
  })
  .catch(err => {
    document.getElementById('cars').innerHTML = `<p class="text-red-600 text-center">Error loading cars: ${err.message}</p>`;
  });

async function bookCar(car_id) {
  const start = document.getElementById(`start-${car_id}`).value;
  const end = document.getElementById(`end-${car_id}`).value;
  const token = localStorage.getItem('auth_token');

  if (!start || !end) return alert('Please select both start and end dates.');

  const btn = document.getElementById(`book-btn-${car_id}`);
  btn.disabled = true;
  btn.innerText = 'Booking...';

  try {
    const res = await fetch(`${BACKEND_URL}/api/book`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({
        car_id,
        customer_id,
        start_date: `${start.split('/').reverse().join('-')}`,
        end_date: `${end.split('/').reverse().join('-')}`
      })
    });

    const data = await res.json();
    btn.disabled = false;
    btn.innerText = 'Book';

    if (!res.ok) return alert(data.message || 'Booking failed.');
    alert(data.message || 'Booking successful!');
    window.location.href = '/history.html';
  } catch (err) {
    btn.disabled = false;
    btn.innerText = 'Book';
    alert('Error: ' + err.message);
  }
}
</script>

</body>
</html>
