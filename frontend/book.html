<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book a Car | A6 Cars</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Navbar -->
  <div id="navbar"></div>
  <script>
    fetch("/navbar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar").innerHTML = html;
      });
  </script>

  <!-- Redirect if not logged in -->
  <script>
    const customer_id = localStorage.getItem("customer_id");
    const customer_name = localStorage.getItem("customer_name");

    if (!customer_id) {
      alert("Please log in to book cars.");
      window.location.href = "/login.html";
    }
  </script>

  <div class="h-20"></div>

  <div class="text-center mb-6">
    <h1 class="text-3xl font-bold text-blue-700">Book Your Car</h1>
    <p class="text-gray-600">Welcome ${localStorage.getItem("customer_name") || ""}! Choose a car and book your ride.</p>
  </div>

  <!-- Cars Grid -->
  <div id="cars" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 px-6 pb-10"></div>

<script>
  // üåê Detect backend URL (local development vs production)
  const BACKEND_URL =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:10000"
      : "https://a6cars-latest.onrender.com";

  const customer_id = localStorage.getItem("customer_id");
  const customer_name = localStorage.getItem("customer_name");

  // Load available cars
  async function loadCars() {
    const container = document.getElementById("cars");
    container.innerHTML = `<p class='text-center text-gray-500 col-span-3'>Loading cars...</p>`;

    try {
      const res = await fetch(`${BACKEND_URL}/api/cars`);
      const cars = await res.json();

      if (!Array.isArray(cars) || cars.length === 0) {
        container.innerHTML = `<p class='text-center text-gray-600 col-span-3'>No cars available currently.</p>`;
        return;
      }

      container.innerHTML = "";

      cars.forEach(car => {
        const images = car.images?.length
          ? car.images.map(img => `<div class="swiper-slide"><img src="${img}" class="w-full h-48 object-cover rounded-lg"></div>`).join("")
          : `<div class="swiper-slide"><img src="https://via.placeholder.com/400x300?text=No+Image" class="w-full h-48 object-cover rounded-lg"></div>`;

        const div = document.createElement("div");
        div.className = "bg-white p-4 rounded-lg shadow text-center";
        div.innerHTML = `
          <div class="swiper carSwiper mb-3">
            <div class="swiper-wrapper">${images}</div>
            <div class="swiper-pagination"></div>
          </div>

          <h2 class="text-xl font-bold">${car.brand} ${car.model}</h2>
          <p class="text-gray-600">Year: ${car.year}</p>
          <p class="text-gray-600">Rate: ‚Çπ${car.daily_rate}/day</p>
          <p class="text-gray-600 mb-2">Location: ${car.location}</p>

          <div class="space-y-2">
            <input type="text" id="start-${car.id}" placeholder="Start Date" class="border rounded p-2 w-full" />
            <input type="text" id="end-${car.id}" placeholder="End Date" class="border rounded p-2 w-full" />
            <button id="book-btn-${car.id}" onclick="bookCar(${car.id})" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700">Book Now</button>
          </div>
        `;

        container.appendChild(div);

        flatpickr(`#start-${car.id}`, { dateFormat: "Y-m-d", minDate: "today" });
        flatpickr(`#end-${car.id}`, { dateFormat: "Y-m-d", minDate: "today" });
      });

      new Swiper(".carSwiper", {
        loop: true,
        pagination: { el: ".swiper-pagination", clickable: true }
      });

    } catch (err) {
      container.innerHTML = `<p class='text-red-600 text-center col-span-3'>Error loading cars: ${err.message}</p>`;
    }
  }

  // Book a car
  async function bookCar(car_id) {
    const start = document.getElementById(`start-${car_id}`).value;
    const end = document.getElementById(`end-${car_id}`).value;

    if (!start || !end) return alert("Please select both start and end dates.");

    const btn = document.getElementById(`book-btn-${car_id}`);
    btn.disabled = true;
    btn.innerText = "Booking...";

    try {
      const res = await fetch(`${BACKEND_URL}/api/book`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ car_id, customer_id, start_date: start, end_date: end })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.message || "Booking failed.");

      alert("‚úÖ Booking created successfully!");
      showPopupQR("Scan to Pay", `Pay ‚Çπ${data.total} to A6 Cars`, data.payment_qr);

      pollForCollectionQR(data.booking_id);

    } catch (err) {
      alert("‚ùå " + err.message);
    } finally {
      btn.disabled = false;
      btn.innerText = "Book Now";
    }
  }

  function showPopupQR(title, desc, qr) {
    const qrPopup = document.createElement("div");
    qrPopup.className = "fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50";
    qrPopup.innerHTML = `
      <div class="bg-white p-6 rounded-lg text-center max-w-sm">
        <h2 class="text-xl font-bold mb-2 text-blue-700">${title}</h2>
        <p class="text-gray-600 mb-2">${desc}</p>
        <img src="${qr}" alt="QR Code" class="mx-auto w-56 h-56 rounded border mb-3">
        <button class="mt-4 bg-red-600 text-white px-4 py-2 rounded w-full hover:bg-red-700" onclick="this.closest('.fixed').remove()">Close</button>
      </div>`;
    document.body.appendChild(qrPopup);
  }

  async function pollForCollectionQR(booking_id) {
    const interval = setInterval(async () => {
      try {
        const res = await fetch(`${BACKEND_URL}/api/mybookings/${customer_id}`);
        const data = await res.json();
        const bk = data.find(b => b.booking_id === booking_id);

        if (bk?.collection_qr) {
          clearInterval(interval);
          showPopupQR(
            "Show this QR at pickup",
            "Admin will scan this QR when you collect your car",
            bk.collection_qr
          );

          const a = document.createElement("a");
          a.href = bk.collection_qr;
          a.download = `collection_qr_${booking_id}.png`;
          a.click();
        }
      } catch {}
    }, 5000);
  }

  loadCars();
</script>

</body>
</html>
