<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .lb-backdrop { background: rgba(0,0,0,0.7); }
    .status-paid { color: #16a34a; font-weight: bold; }
    .status-pending { color: #dc2626; font-weight: bold; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Backend base URL -->
  <script>
    const BACKEND_URL =
      (location.hostname === "localhost" || location.hostname === "127.0.0.1")
        ? "http://localhost:10000"
        : "https://a6cars-latest.onrender.com";

    function api(path) {
      return BACKEND_URL + path;
    }
  </script>

  <div class="h-16"></div>

  <div class="max-w-6xl mx-auto p-6">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-2xl font-bold">Admin Panel</h1>
          <p class="text-sm text-gray-500">Manage cars, bookings and verify payments</p>
        </div>
        <button id="admin-logout" class="bg-red-600 text-white px-3 py-1 rounded hidden">Logout</button>
      </div>

      <!-- Admin Login -->
      <div id="admin-login" class="max-w-md mx-auto space-y-4">
        <input id="admin-email" type="text" placeholder="Admin Email" class="w-full p-3 border rounded">
        <input id="admin-password" type="password" placeholder="Password" class="w-full p-3 border rounded">
        <button id="admin-login-btn" class="bg-green-600 text-white px-4 py-2 rounded w-full">Login</button>
        <div id="admin-login-msg" class="text-sm text-red-600"></div>
      </div>

      <!-- Dashboard -->
      <div id="admin-dashboard" class="hidden mt-6">

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="p-4 rounded shadow-sm bg-blue-50">
            <div class="text-sm text-gray-500">Total Bookings</div>
            <div id="stat-bookings" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-4 rounded shadow-sm bg-yellow-50">
            <div class="text-sm text-gray-500">Pending Payments</div>
            <div id="stat-pending" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-4 rounded shadow-sm bg-green-50">
            <div class="text-sm text-gray-500">Available Cars</div>
            <div id="stat-cars" class="text-2xl font-bold">—</div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <!-- Add Car -->
          <div class="p-4 border rounded bg-white">
            <h3 class="font-semibold mb-3 text-lg">Add Car (multiple images)</h3>
            <form id="addCarForm" enctype="multipart/form-data" class="space-y-3">
              <input type="text" name="brand" placeholder="Brand" required class="w-full p-2 border rounded">
              <input type="text" name="model" placeholder="Model" required class="w-full p-2 border rounded">
              <input type="number" name="year" placeholder="Year" required class="w-full p-2 border rounded">
              <input type="number" step="0.01" name="daily_rate" placeholder="Daily Rate (INR)" required class="w-full p-2 border rounded">
              <input type="text" name="location" placeholder="Location" required class="w-full p-2 border rounded">
              <input type="file" name="images" id="images-input" accept=".jpg,.jpeg" multiple required class="w-full p-2 border rounded bg-gray-50">
              <div id="images-preview" class="flex flex-wrap gap-2"></div>
              <button type="submit" class="bg-blue-600 text-white w-full p-2 rounded">Add Car</button>
            </form>
          </div>

          <!-- Manage Cars -->
          <div class="p-4 border rounded bg-white lg:col-span-2">
            <h3 class="font-semibold mb-3 text-lg">Manage Cars</h3>
            <div id="car-list" class="space-y-3"></div>

            <div id="car-bookings-panel" class="hidden mt-4 bg-gray-50 p-3 rounded">
              <div class="flex justify-between items-center mb-2">
                <h4 class="font-medium">Bookings for <span id="car-bookings-title"></span></h4>
                <button id="close-car-bookings" class="bg-gray-300 px-2 rounded">Close</button>
              </div>
              <table class="w-full text-left border-collapse text-sm overflow-auto">
                <thead>
                  <tr>
                    <th class="border px-2 py-1">Booking ID</th>
                    <th class="border px-2 py-1">Customer</th>
                    <th class="border px-2 py-1">From</th>
                    <th class="border px-2 py-1">To</th>
                    <th class="border px-2 py-1">Amount</th>
                    <th class="border px-2 py-1">Paid</th>
                    <th class="border px-2 py-1">Verified</th>
                  </tr>
                </thead>
                <tbody id="car-bookings-body"></tbody>
              </table>
            </div>
          </div>

          <!-- Verify QR -->
          <div id="col-verify" class="hidden lg:col-span-3 p-4 border rounded bg-white">
            <h3 class="font-semibold mb-3 text-lg">Verify Payment (Scan QR)</h3>
            <video id="video" width="100%" height="220" class="border"></video>
            <p id="scan-status" class="text-sm mt-2"></p>
            <button id="stop-scan" class="mt-2 bg-red-600 text-white px-3 py-1 rounded">Stop Scan</button>
            <div id="qr-result" class="mt-3 text-sm"></div>
          </div>

        </div>

        <!-- Transactions -->
        <div class="bg-white p-4 rounded mt-6">
          <h3 class="font-semibold mb-3 text-lg">Recent Transactions</h3>
          <table class="w-full text-left text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="border px-2 py-1">Payment ID</th>
                <th class="border px-2 py-1">Customer</th>
                <th class="border px-2 py-1">Car</th>
                <th class="border px-2 py-1">From</th>
                <th class="border px-2 py-1">To</th>
                <th class="border px-2 py-1">Amount</th>
                <th class="border px-2 py-1">Paid</th>
                <th class="border px-2 py-1">Verified</th>
              </tr>
            </thead>
            <tbody id="tx-body"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="hidden fixed inset-0 z-50 items-center justify-center">
    <div class="absolute inset-0 lb-backdrop"></div>
    <div class="relative bg-white rounded p-4 z-50 max-w-3xl mx-4">
      <div class="flex justify-between items-center mb-3">
        <p id="lb-title" class="font-semibold text-lg"></p>
        <button id="lb-close" class="bg-red-600 text-white px-3 py-1 rounded">Close</button>
      </div>
      <div id="lb-images" class="flex gap-2 overflow-x-auto"></div>
    </div>
  </div>

  <!-- jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    /* ========================= Admin Auth ========================= */
    function getAdminToken(){ return sessionStorage.getItem("adminToken"); }
    function setAdminToken(t){
      sessionStorage.setItem("adminToken", t);
      sessionStorage.setItem("adminLoggedIn", "1");
      document.getElementById("admin-login").classList.add("hidden");
      document.getElementById("admin-dashboard").classList.remove("hidden");
      document.getElementById("admin-logout").classList.remove("hidden");
      loadCarList(); loadTransactions();
    }

    document.getElementById("admin-login-btn").addEventListener("click", async () => {
      const email = admin-email.value.trim();
      const password = admin-password.value;
      try {
        const res = await fetch(api("/api/admin/login"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.message || "Login failed");
        setAdminToken(json.token);
      } catch (err) {
        admin-login-msg.innerText = err.message;
      }
    });

    document.getElementById("admin-logout").addEventListener("click", () => {
      sessionStorage.clear();
      location.reload();
    });

    /* ========================= Add Car ========================= */
    images-input.addEventListener("change", () => {
      images-preview.innerHTML = "";
      [...images-input.files].forEach(f => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(f);
        img.className = "w-28 h-20 rounded border";
        images-preview.appendChild(img);
      });
    });

    addCarForm.addEventListener("submit", async e => {
      e.preventDefault();
      const t = getAdminToken();
      if (!t) return alert("Login first");
      const fd = new FormData(addCarForm);
      const res = await fetch(api("/api/admin/addcar"), {
        method: "POST",
        headers: { Authorization: "Bearer " + t },
        body: fd
      });
      const json = await res.json();
      if (!res.ok) return alert(json.message);
      alert("Car added");
      loadCarList();
      addCarForm.reset();
      images-preview.innerHTML = "";
    });

    /* ========================= Manage Cars ========================= */
    async function loadCarList(){
      const res = await fetch(api("/api/cars"));
      const list = await res.json();
      const div = car-list;
      div.innerHTML = "";
      list.forEach(car => {
        let imgs = (car.images || []).map(i => i.startsWith("http") ? i : BACKEND_URL + i);
        const thumb = imgs[0] || "https://via.placeholder.com/160x100?text=No+Image";
        div.innerHTML += `
          <div class="border p-3 rounded flex justify-between items-center">
            <div class="flex gap-3 items-center">
              <img src="${thumb}" class="w-36 h-24 rounded border cursor-pointer" onclick='openLightbox(${JSON.stringify(imgs)}, "${car.brand} ${car.model}")'>
              <div>
                <p class="font-semibold">${car.brand} ${car.model}</p>
                <p class="text-sm text-gray-600">₹${car.daily_rate}/day — ${car.year}</p>
                <p class="text-xs text-gray-500">${car.location}</p>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="bg-blue-600 text-white px-3 py-1 rounded" onclick='viewCarBookings(${car.id}, "${car.brand} ${car.model}")'>View</button>
              <button class="bg-red-600 text-white px-3 py-1 rounded" onclick="deleteCar(${car.id}, this)">Delete</button>
            </div>
          </div>`;
      });
      document.getElementById("stat-cars").innerText = list.length;
    }

    async function deleteCar(id, btn){
      if (!confirm("Delete this car?")) return;
      const t = getAdminToken();
      const res = await fetch(api("/api/deletecar"), {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + t },
        body: JSON.stringify({ car_id: id })
      });
      const json = await res.json();
      if (!res.ok) return alert(json.message);
      alert("Car deleted");
      loadCarList();
    }

    /* ========================= Bookings Of A Car ========================= */
    function viewCarBookings(carId, name){
      car-bookings-panel.classList.remove("hidden");
      car-bookings-title.innerText = name;
      car-bookings-body.innerHTML = `<tr><td colspan="7">Loading...</td></tr>`;
      const t = getAdminToken();
      fetch(api(`/api/car-bookings/${carId}`), {
        headers: { Authorization: "Bearer " + t }
      }).then(r => r.json()).then(list => {
        car-bookings-body.innerHTML = list.map(b => `
          <tr>
            <td class="border px-2 py-1">${b.booking_id}</td>
            <td class="border px-2 py-1">${b.customer_name}</td>
            <td class="border px-2 py-1">${new Date(b.start_date).toLocaleDateString()}</td>
            <td class="border px-2 py-1">${new Date(b.end_date).toLocaleDateString()}</td>
            <td class="border px-2 py-1">₹${b.amount}</td>
            <td class="border px-2 py-1">${b.paid ? "Yes" : "No"}</td>
            <td class="border px-2 py-1">${b.verified ? "Yes" : "No"}</td>
          </tr>`).join("");
      });
    }
    close-car-bookings.onclick = () => car-bookings-panel.classList.add("hidden");

    /* ========================= Transactions ========================= */
    async function loadTransactions(){
      const t = getAdminToken();
      const res = await fetch(api("/api/admin/transactions?page=1&pageSize=20"), {
        headers: { Authorization: "Bearer " + t }
      });
      const json = await res.json();
      tx-body.innerHTML = json.data.map(tx => `
        <tr>
          <td class="border px-2 py-1">${tx.payment_id}</td>
          <td class="border px-2 py-1">${tx.customer_name} (${tx.email})</td>
          <td class="border px-2 py-1">${tx.brand} ${tx.model}</td>
          <td class="border px-2(py-1)">${new Date(tx.start_date).toLocaleDateString()}</td>
          <td class="border px-2(py-1)">${new Date(tx.end_date).toLocaleDateString()}</td>
          <td class="border px-2(py-1)">₹${tx.amount}</td>
          <td class="border px-2(py-1)">${tx.paid ? "Yes" : "No"}</td>
          <td class="border px-2(py-1)">${tx.verified ? "Yes" : "No"}</td>
        </tr>
      `).join("");
      stat-bookings.innerText = json.total;
      stat-pending.innerText = json.data.filter(x => !x.paid).length;
    }

    /* ========================= Lightbox ========================= */
    function openLightbox(arr, title){
      lb-title.innerText = title;
      lb-images.innerHTML = arr.map(u => `<img src="${u}" class="max-h-96 object-contain mr-2">`).join("");
      lightbox.classList.add("flex");
    }
    lb-close.onclick = () => lightbox.classList.remove("flex");

    /* ========================= Init Session ========================= */
    (function init(){
      const t = getAdminToken();
      if (t) {
        admin-login.classList.add("hidden");
        admin-dashboard.classList.remove("hidden");
        admin-logout.classList.remove("hidden");
        loadCarList(); loadTransactions();
      }
    })();
  </script>

</body>
</html>
