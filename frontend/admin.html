<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin Panel | A6 Cars</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto; }
    .toast{position:fixed;right:20px;bottom:20px;background:#111;color:#fff;padding:10px 16px;border-radius:8px;z-index:9999}
    .toast-success{background:#16a34a}
    .toast-error{background:#dc2626}
    .sidebar.active{transform:translateX(0)}
    .sidebar{transform:translateX(-100%);transition:.3s}
    @media(min-width:1024px){.sidebar{transform:none}}
  </style>
</head>

<body class="bg-gray-100">

<!-- Sidebar Overlay -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black/40 hidden z-40"></div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar fixed left-0 top-0 w-72 h-full bg-white z-50 shadow-lg">
  <div class="p-6 border-b flex gap-3 items-center">
    <div class="w-10 h-10 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold">A6</div>
    <div>
      <div class="font-bold">A6 Cars</div>
      <div class="text-xs text-gray-500">Admin Panel</div>
    </div>
  </div>

  <nav class="p-4 space-y-1">
    <button class="menu-item block w-full text-left p-2 rounded hover:bg-blue-50" data-section="dashboard">Dashboard</button>
    <button class="menu-item block w-full text-left p-2 rounded hover:bg-blue-50" data-section="addCar">Add Car</button>
    <button class="menu-item block w-full text-left p-2 rounded hover:bg-blue-50" data-section="manageCars">Manage Cars</button>
    <button class="menu-item block w-full text-left p-2 rounded hover:bg-blue-50" data-section="schedule">Schedule</button>
    <button class="menu-item block w-full text-left p-2 rounded hover:bg-blue-50" data-section="verifyPayment">Verify Payment</button>
    <button class="menu-item block w-full text-left p-2 rounded hover:bg-blue-50" data-section="cancellations">Cancellations</button>
    <button class="menu-item block w-full text-left p-2 rounded hover:bg-blue-50" data-section="business">Business</button>

    <button id="logoutBtn" class="mt-4 w-full bg-red-600 text-white py-2 rounded">
      Logout
    </button>
  </nav>
</aside>

<!-- Main -->
<main class="lg:ml-72 min-h-screen">

<!-- Top bar -->
<header class="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-30">
  <div class="flex items-center gap-3">
    <button id="sidebarToggle"><i class="fas fa-bars"></i></button>
    <h2 id="pageTitle" class="font-bold text-xl">Dashboard</h2>
  </div>
</header>

<!-- Login -->
<section id="loginSection" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-6 rounded shadow w-full max-w-md">
    <h2 class="text-xl font-bold mb-4 text-center">Admin Login</h2>

    <form id="loginForm" class="space-y-3">
      <input id="adminEmail" type="email" class="w-full p-2 border rounded" placeholder="Email" required/>
      <input id="adminPassword" type="password" class="w-full p-2 border rounded" placeholder="Password" required/>
      <button class="w-full bg-blue-600 text-white py-2 rounded">Login</button>
      <div id="loginError" class="text-red-600 text-sm hidden"></div>
    </form>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboardSection" class="hidden p-6">
  <h3 class="font-bold text-lg mb-4">Dashboard</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white p-4 rounded shadow">Bookings: <span id="statBookings">—</span></div>
    <div class="bg-white p-4 rounded shadow">Cars: <span id="statCars">—</span></div>
    <div class="bg-white p-4 rounded shadow">Cancellations: <span id="statCancellations">—</span></div>
  </div>
</section>

<section id="addCarSection" class="hidden p-6">
  <div class="bg-white p-4 rounded shadow max-w-xl">
    <h3 class="font-bold mb-3">Add Car</h3>
    <form id="addCarForm" enctype="multipart/form-data" class="space-y-3">
      <input name="brand" class="w-full border p-2 rounded" placeholder="Brand" required>
      <input name="model" class="w-full border p-2 rounded" placeholder="Model" required>
      <input name="year" type="number" class="w-full border p-2 rounded" placeholder="Year" required>
      <input name="daily_rate" type="number" class="w-full border p-2 rounded" placeholder="Rate" required>
      <input name="location" class="w-full border p-2 rounded" placeholder="Location" required>
      <input type="file" name="images" multiple accept=".jpg,.jpeg" required>
      <button class="bg-blue-600 text-white px-4 py-2 rounded">Add Car</button>
    </form>
  </div>
</section>

<section id="manageCarsSection" class="hidden p-6">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="font-bold mb-3">Manage Cars</h3>
    <div id="carsList">Loading...</div>
  </div>
</section>

<section id="scheduleSection" class="hidden p-6">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="font-bold mb-3">Schedule</h3>
    <select id="scheduleCarSelect" class="border p-2 rounded"></select>
    <button id="viewScheduleBtn" class="bg-blue-600 text-white px-3 py-1 rounded ml-2">View</button>
    <div id="scheduleResult" class="mt-4"></div>
  </div>
</section>

<section id="verifyPaymentSection" class="hidden p-6">
  <div class="bg-white p-4 rounded shadow max-w-xl">
    <h3 class="font-bold mb-3">Verify Payment</h3>
    <video id="qrVideo" class="w-full border rounded"></video>
    <div class="mt-2 flex gap-2">
      <button id="startScanBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Start</button>
      <button id="stopScanBtn" class="bg-red-600 text-white px-3 py-1 rounded">Stop</button>
    </div>
    <div id="qrResult" class="mt-3"></div>
  </div>
</section>

<section id="cancellationsSection" class="hidden p-6">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="font-bold mb-3">Cancellations</h3>
    <div id="cancellationsBody">Loading...</div>
  </div>
</section>

<section id="businessSection" class="hidden p-6">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="font-bold mb-3">Business</h3>
    <p>Coming soon…</p>
  </div>
</section>

</main>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const BACKEND_URL =
  location.hostname === "localhost"
    ? "http://localhost:3000"
    : "https://a6cars-backend-ylx7.onrender.com";

const sections = {
  dashboard: "dashboardSection",
  addCar: "addCarSection",
  manageCars: "manageCarsSection",
  schedule: "scheduleSection",
  verifyPayment: "verifyPaymentSection",
  cancellations: "cancellationsSection",
  business: "businessSection",
};

function api(p){ return BACKEND_URL + p }

function getToken(){ return sessionStorage.getItem("adminToken") }
function setToken(t){ sessionStorage.setItem("adminToken",t); initApp() }
function logout(){ sessionStorage.clear(); location.reload() }

function toast(msg,type="success"){
  const t=document.createElement("div");
  t.className="toast toast-"+type;
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function show(sec){
  Object.values(sections).forEach(id=>document.getElementById(id).classList.add("hidden"));
  document.getElementById(sections[sec]).classList.remove("hidden");
  document.getElementById("pageTitle").textContent=sec.toUpperCase();
}

document.querySelectorAll(".menu-item").forEach(b=>{
  b.onclick=()=>show(b.dataset.section)
});

document.getElementById("logoutBtn").onclick=logout;

document.getElementById("sidebarToggle").onclick=()=>{
  sidebar.classList.toggle("active");
  sidebarOverlay.classList.toggle("hidden");
};

sidebarOverlay.onclick=()=>{
  sidebar.classList.remove("active");
  sidebarOverlay.classList.add("hidden");
};

/* LOGIN */
loginForm.onsubmit=async e=>{
  e.preventDefault();
  try{
    const res=await fetch(api("/api/admin/login"),{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        email:adminEmail.value,
        password:adminPassword.value
      })
    });
    const data=await res.json();
    if(!res.ok) throw new Error(data.message);
    setToken(data.token);
  }catch(err){
    loginError.textContent=err.message;
    loginError.classList.remove("hidden");
  }
};

function initApp(){
  loginSection.classList.add("hidden");
  show("dashboard");
  loadCars();
}

async function loadCars(){
  const res=await fetch(api("/api/cars"));
  const cars=await res.json();
  statCars.textContent=cars.length;
}

if(getToken()) initApp();
</script>
</body>
</html>
