<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/video-bg.css">

  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #1e40af;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #e6b765;
      --light: #f3f4f6;
      --border: #e5e7eb;
    }

    * {
      transition: all 0.3s ease;
    }

    body {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 280px;
      background: white;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      z-index: 40;
      overflow-y: auto;
      transform: translateX(-100%);
    }

    .sidebar.active {
      transform: translateX(0);
    }

    @media (min-width: 1024px) {
      .sidebar {
        transform: translateX(0);
      }
    }

    .sidebar-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: #6b7280;
      cursor: pointer;
      border-left: 4px solid transparent;
      font-size: 0.95rem;
    }

    .sidebar-menu-item:hover {
      background: var(--light);
      color: var(--primary);
    }

    .sidebar-menu-item.active {
      background: var(--light);
      color: var(--primary);
      border-left-color: var(--primary);
      font-weight: 600;
    }

    .sidebar-menu-item i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }

    /* Card Styles */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      padding: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--light);
      padding-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    /* Button Styles */
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-secondary {
      background: var(--light);
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    /* Stat Card */
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-left: 4px solid var(--primary);
    }

    .stat-card.success {
      border-left-color: var(--success);
    }

    .stat-card.warning {
      border-left-color: var(--warning);
    }

    .stat-card.danger {
      border-left-color: var(--danger);
    }

    .stat-value {
      font-size: 1.875rem;
      font-weight: 700;
      color: #111827;
      margin: 8px 0;
    }

    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Table Styles */
    .table-responsive {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .table thead {
      background: var(--light);
    }

    .table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid var(--border);
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      color: #6b7280;
    }

    .table tr:hover {
      background: var(--light);
    }

    /* Badge Styles */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }

    /* Form Styles */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    .form-label {
      font-weight: 500;
      color: #374151;
      font-size: 0.875rem;
    }

    .form-control {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Toggle Sidebar Button */
    .sidebar-toggle {
      display: none;
      background: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--primary);
      font-size: 1.5rem;
    }

    @media (max-width: 1023px) {
      .sidebar-toggle {
        display: flex;
      }
    }

    /* Overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 30;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 16px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 9999;
      animation: slideIn 0.3s ease;
    }

    .toast-success {
      background: var(--success);
    }

    .toast-error {
      background: var(--danger);
    }

    .toast-info {
      background: var(--primary);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 240px;
      }

      .card {
        padding: 16px;
      }

      .stat-value {
        font-size: 1.5rem;
      }

      .table {
        font-size: 0.75rem;
      }

      .table th,
      .table td {
        padding: 8px;
      }
    }
  </style>
</head>

<body class="bg-gray-100">

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Navigation -->
  <aside class="sidebar" id="sidebar">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 text-white flex items-center justify-center text-lg font-bold">
          A6
        </div>
        <div>
          <h1 class="font-bold text-gray-900">A6 Cars</h1>
          <p class="text-xs text-gray-500">Admin Panel</p>
        </div>
      </div>
    </div>

    <nav class="py-4">
      <div class="px-4 py-2">
        <p class="text-xs font-semibold text-gray-400 uppercase">Main</p>
      </div>

      <div class="sidebar-menu-item active" data-section="dashboard">
        <i class="fas fa-dashboard"></i>
        <span>Dashboard</span>
      </div>

      <div class="px-4 py-2 mt-4">
        <p class="text-xs font-semibold text-gray-400 uppercase">Manage</p>
      </div>

      <div class="sidebar-menu-item" data-section="add-car">
        <i class="fas fa-plus-circle"></i>
        <span>Add Car</span>
      </div>

      <div class="sidebar-menu-item" data-section="manage-cars">
        <i class="fas fa-car"></i>
        <span>Manage Cars</span>
      </div>

      <div class="sidebar-menu-item" data-section="schedule">
        <i class="fas fa-calendar-alt"></i>
        <span>Schedule</span>
      </div>

      <div class="px-4 py-2 mt-4">
        <p class="text-xs font-semibold text-gray-400 uppercase">Finance</p>
      </div>

      <div class="sidebar-menu-item" data-section="verify-payment">
        <i class="fas fa-check-circle"></i>
        <span>Verify Payment</span>
      </div>

      <div class="sidebar-menu-item" data-section="cancellations">
        <i class="fas fa-ban"></i>
        <span>Cancellations</span>
      </div>

      <div class="px-4 py-2 mt-4">
        <p class="text-xs font-semibold text-gray-400 uppercase">Other</p>
      </div>

      <div class="sidebar-menu-item" data-section="business">
        <i class="fas fa-cog"></i>
        <span>Business Details</span>
      </div>

      <div class="border-t mt-4 pt-4 px-4">
       <!-- <button class="w-full btn btn-danger text-sm justify-center" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>-->
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="lg:ml-[280px] min-h-screen">
    <!-- Top Navbar -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
      <div class="px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>
          <h2 class="text-xl font-bold text-gray-900" id="pageTitle">Dashboard</h2>
        </div>
        <div class="flex items-center gap-4">
          <button class="btn btn-danger hidden" id="topLogoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Login Section -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center px-4 py-8">
      <div class="card max-w-md w-full">
        <div class="text-center mb-8">
          <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 text-white flex items-center justify-center text-3xl font-bold mx-auto mb-4">
            A6
          </div>
          <h1 class="text-2xl font-bold text-gray-900">Admin Login</h1>
          <p class="text-sm text-gray-500 mt-2">Secure Access</p>
        </div>

        <form id="loginForm" class="space-y-4">
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input id="adminEmail" type="email" class="form-control" placeholder="admin@example.com" required>
          </div>

          <div class="form-group">
            <label class="form-label">Password</label>
            <input id="adminPassword" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>

          <button type="submit" class="btn btn-primary w-full justify-center mt-6">
            <i class="fas fa-lock"></i>
            Sign In
          </button>

          <div id="loginError" class="p-3 bg-red-50 text-red-600 text-sm rounded-lg hidden"></div>
        </form>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="hidden">
      <div class="px-6 py-8">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <div class="stat-card">
            <div class="stat-label">Total Bookings</div>
            <div class="stat-value" id="statBookings">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">All time bookings</p>
          </div>

          <div class="stat-card warning">
            <div class="stat-label">Pending Payments</div>
            <div class="stat-value" id="statPending">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">Awaiting verification</p>
          </div>

          <div class="stat-card success">
            <div class="stat-label">Available Cars</div>
            <div class="stat-value" id="statCars">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">Ready to rent</p>
          </div>

          <div class="stat-card danger">
            <div class="stat-label">Cancellations</div>
            <div class="stat-value" id="statCancellations">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">Pending refunds</p>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
          <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">Recent Transactions</h3>
            <button class="btn btn-secondary text-xs">
              <i class="fas fa-refresh"></i> Refresh
            </button>
          </div>

          <div class="table-responsive">
            <table class="table" id="recentTransactionsTable">
              <thead>
                <tr>
                  <th>Payment ID</th>
                  <th>Customer</th>
                  <th>Car</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="transactionBody">
                <tr>
                  <td colspan="6" class="text-center py-6 text-gray-500">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Car Section -->
    <div id="addCarSection" class="hidden px-6 py-8">
      <div class="card max-w-2xl">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Add New Car</h3>
        </div>

        <form id="addCarForm" enctype="multipart/form-data" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
              <label class="form-label">Brand</label>
              <input type="text" name="brand" class="form-control" placeholder="Toyota" required>
            </div>

            <div class="form-group">
              <label class="form-label">Model</label>
              <input type="text" name="model" class="form-control" placeholder="Fortuner" required>
            </div>

            <div class="form-group">
              <label class="form-label">Year</label>
              <input type="number" name="year" class="form-control" placeholder="2023" required>
            </div>

            <div class="form-group">
              <label class="form-label">Daily Rate (‚Çπ)</label>
              <input type="number" step="0.01" name="daily_rate" class="form-control" placeholder="5000" required>
            </div>

            <div class="form-group md:col-span-2">
              <label class="form-label">Location</label>
              <input type="text" name="location" class="form-control" placeholder="Bangalore" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Car Images (JPG/JPEG)</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50" id="imageUploadArea">
              <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
              <p class="text-gray-600 font-medium">Click or drag images here</p>
              <p class="text-xs text-gray-500">JPG/JPEG files up to 5MB each</p>
              <input type="file" name="images" id="imagesInput" class="hidden" accept=".jpg,.jpeg" multiple required>
            </div>
            <div id="imagesPreview" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
          </div>

          <button type="submit" class="btn btn-primary w-full justify-center">
            <i class="fas fa-plus"></i> Add Car
          </button>
        </form>
      </div>
    </div>

    <!-- Manage Cars Section -->
    <div id="manageCarsSection" class="hidden px-6 py-8">
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Manage Cars</h3>
          <input type="text" id="carSearchInput" class="form-control w-full md:w-64" placeholder="Search cars...">
        </div>

        <div id="carsList" class="space-y-4">
          <p class="text-center text-gray-500 py-8">Loading cars...</p>
        </div>
      </div>
    </div>

    <!-- Schedule Section -->
    <div id="scheduleSection" class="hidden px-6 py-8">
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Car Schedule & Vacancies</h3>
        </div>

        <div class="space-y-4">
          <div class="form-group">
            <label class="form-label">Select Car</label>
            <select id="scheduleCarSelect" class="form-control">
              <option value="">Loading cars...</option>
            </select>
          </div>

          <button class="btn btn-primary" id="viewScheduleBtn">
            <i class="fas fa-search"></i> View Schedule
          </button>

          <div id="scheduleResult" class="mt-6"></div>
        </div>
      </div>
    </div>

    <!-- Verify Payment Section -->
    <div id="verifyPaymentSection" class="hidden px-6 py-8">
      <div class="card max-w-2xl">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Verify Payment (QR Scanner)</h3>
        </div>

        <div id="qrResult" class="mb-4"></div>

        <div class="space-y-4">
          <video id="video" class="w-full border-2 border-gray-300 rounded-lg mb-4" height="300"></video>

          <div id="scanStatus" class="text-sm text-gray-600 text-center"></div>

          <div class="flex gap-3 justify-center flex-wrap">
            <button class="btn btn-primary" id="startScanBtn">
              <i class="fas fa-camera"></i> Start Scan
            </button>
            <button class="btn btn-danger" id="stopScanBtn">
              <i class="fas fa-stop"></i> Stop Scan
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cancellations Section -->
    <div id="cancellationsSection" class="hidden px-6 py-8">
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Cancellations & Refunds</h3>
          <button class="btn btn-success" id="processAllRefundsBtn">
            <i class="fas fa-check"></i> Process All Refunds
          </button>
        </div>

        <div class="table-responsive">
          <table class="table" id="cancellationsTable">
            <thead>
              <tr>
                <th>Booking ID</th>
                <th>Customer</th>
                <th>Car</th>
                <th>Reason</th>
                <th>Cancelled At</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="cancellationsBody">
              <tr>
                <td colspan="6" class="text-center py-6 text-gray-500">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Business Details Section -->
    <div id="businessSection" class="hidden px-6 py-8">
      <div class="card max-w-2xl">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Business Details</h3>
        </div>

        <div class="p-6 text-center bg-blue-50 rounded-lg">
          <i class="fas fa-info-circle text-3xl text-blue-600 mb-3"></i>
          <p class="text-gray-700 font-medium">Business settings coming soon</p>
          <p class="text-sm text-gray-500 mt-2">Add GST, company information, and legal details here</p>
        </div>
      </div>
    </div>

  </main>

  <!-- Backend Config & Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const BACKEND_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:3000'
      : 'https://a6cars-backend-ylx7.onrender.com';

    function api(path) {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return path;
      return BACKEND_URL + path;
    }

    function getAdminToken() {
      return sessionStorage.getItem('adminToken') || '';
    }

    function setAdminToken(token) {
      sessionStorage.setItem('adminToken', token);
      sessionStorage.setItem('adminLoggedIn', '1');
      showSection('dashboard');
      loadDashboard();
    }

    function removeAdminToken() {
      sessionStorage.clear();
      location.reload();
    }

    function showToast(msg, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Sidebar Toggle
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const sidebarToggle = document.getElementById('sidebarToggle');

    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      sidebarOverlay.classList.toggle('active');
    });

    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    });

    // Section Navigation
    function showSection(sectionId) {
      const sections = ['dashboardSection', 'addCarSection', 'manageCarsSection', 'scheduleSection', 'verifyPaymentSection', 'cancellationsSection', 'businessSection'];
      sections.forEach(sec => document.getElementById(sec).classList.add('hidden'));

      if (sectionId === 'login') {
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('topLogoutBtn').classList.add('hidden');
      } else if (getAdminToken()) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById(sectionId + 'Section').classList.remove('hidden');
        document.getElementById('topLogoutBtn').classList.remove('hidden');

        document.querySelectorAll('.sidebar-menu-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-section="${sectionId}"]`)?.classList.add('active');

        const titles = { 'dashboard': 'Dashboard', 'add-car': 'Add Car', 'manage-cars': 'Manage Cars', 'schedule': 'Schedule', 'verify-payment': 'Verify Payment', 'cancellations': 'Cancellations', 'business': 'Business Details' };
        document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
      } else {
        showSection('login');
      }
    }

    // Sidebar Menu Click
    document.querySelectorAll('.sidebar-menu-item').forEach(el => {
      el.addEventListener('click', () => {
        const section = el.dataset.section;
        showSection(section);
      });
    });

    // Login Form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');

      errorDiv.classList.add('hidden');

      try {
        console.log('Attempting login with:', { email });
        const res = await fetch(api('/api/admin/login'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const text = await res.text();
        console.log('Login response status:', res.status);
        console.log('Login response text:', text);

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse response:', e);
          throw new Error('Invalid server response');
        }

        if (!res.ok) throw new Error(data.message || 'Login failed');

        console.log('Login successful, token:', data.token);
        setAdminToken(data.token);
        showToast('‚úÖ Login successful!', 'success');
      } catch (err) {
        console.error('Login error:', err);
        errorDiv.textContent = '‚ùå ' + err.message;
        errorDiv.classList.remove('hidden');
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', removeAdminToken);
    document.getElementById('topLogoutBtn').addEventListener('click', removeAdminToken);

    // Add Car Image Upload
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imagesInput = document.getElementById('imagesInput');
    const imagesPreview = document.getElementById('imagesPreview');

    imageUploadArea.addEventListener('click', () => imagesInput.click());

    imagesInput.addEventListener('change', (e) => {
      imagesPreview.innerHTML = '';
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'w-full h-24 object-cover rounded-lg';
          imagesPreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // Add Car Form Submit
    document.getElementById('addCarForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const token = getAdminToken();
      if (!token) {
        showToast('‚ùå Not authenticated. Please login again.', 'error');
        return;
      }

      const formData = new FormData(e.target);
      console.log('Adding car with form data:', {
        brand: formData.get('brand'),
        model: formData.get('model'),
        year: formData.get('year'),
        daily_rate: formData.get('daily_rate'),
        location: formData.get('location'),
        imageCount: formData.getAll('images').length
      });

      try {
        const res = await fetch(api('/api/admin/addcar'), {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });

        const text = await res.text();
        console.log('Add car response:', res.status, text);

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse add car response:', e);
          throw new Error('Invalid server response');
        }

        if (!res.ok) throw new Error(data.message || 'Failed to add car');

        showToast('‚úÖ Car added successfully!', 'success');
        e.target.reset();
        imagesPreview.innerHTML = '';
        loadCarList();
      } catch (err) {
        console.error('Add car error:', err);
        showToast('‚ùå ' + err.message, 'error');
      }
    });

    // Load Dashboard
    async function loadDashboard() {
      try {
        console.log('Loading dashboard...');
        const res = await fetch(api('/api/cars'));
        const cars = await res.json();
        console.log('Cars loaded:', cars.length);
        document.getElementById('statCars').textContent = cars.length;

        const txRes = await fetch(api('/api/admin/transactions'), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });
        
        if (!txRes.ok) {
          console.warn('Transactions fetch failed:', txRes.status);
          document.getElementById('statBookings').textContent = '0';
          document.getElementById('transactionBody').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No transactions found</td></tr>';
          return;
        }

        const txData = await txRes.json();
        console.log('Transactions response:', txData);
        
        // Handle both { data: [] } and [] response formats
        const transactions = txData.data || txData;
        console.log('Transactions loaded:', transactions.length);
        document.getElementById('statBookings').textContent = transactions.length || 0;

        const tbody = document.getElementById('transactionBody');
        tbody.innerHTML = (transactions || []).slice(0, 10).map(tx => `
          <tr>
            <td>${tx.payment_id || tx.id}</td>
            <td>${tx.customer_name || 'N/A'}</td>
            <td>${tx.brand} ${tx.model}</td>
            <td>‚Çπ${(tx.payment_amount || tx.amount || 0).toLocaleString()}</td>
            <td><span class="badge ${tx.payment_status === 'completed' || tx.status === 'completed' ? 'badge-success' : 'badge-warning'}">${tx.payment_status || tx.status || 'pending'}</span></td>
            <td>${new Date(tx.start_date || Date.now()).toLocaleDateString()}</td>
          </tr>
        `).join('') || '<tr><td colspan="6" class="text-center py-4 text-gray-500">No transactions found</td></tr>';
      } catch (err) {
        console.error('Dashboard load error:', err);
        document.getElementById('statBookings').textContent = '‚Äî';
        document.getElementById('statCars').textContent = '‚Äî';
        document.getElementById('transactionBody').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading: ' + err.message + '</td></tr>';
      }
    }

    // Load Cars List
    async function loadCarList() {
      try {
        console.log('Loading cars list...');
        const res = await fetch(api('/api/cars'));
        
        if (!res.ok) {
          console.error('Cars fetch failed:', res.status);
          document.getElementById('carsList').innerHTML = '<p class="text-red-500">Failed to load cars</p>';
          return;
        }

        const cars = await res.json();
        console.log('Cars fetched:', cars);
        const carsList = document.getElementById('carsList');

        if (!cars || !Array.isArray(cars) || cars.length === 0) {
          carsList.innerHTML = '<p class="text-center text-gray-500 py-8">No cars found</p>';
          return;
        }

        carsList.innerHTML = cars.map(car => {
          const imageUrl = car.images && car.images[0] 
            ? (car.images[0].startsWith('http') ? car.images[0] : BACKEND_URL + car.images[0]) 
            : 'https://via.placeholder.com/100x80?text=No+Image';
          
          return `
            <div class="border rounded-lg p-4 flex justify-between items-start md:items-center gap-4 hover:shadow-lg">
              <div class="flex gap-4 items-start flex-1">
                <img src="${imageUrl}" class="w-24 h-20 rounded object-cover" onerror="this.src='https://via.placeholder.com/100x80'">
                <div>
                  <h4 class="font-semibold text-gray-900">${car.brand} ${car.model}</h4>
                  <p class="text-sm text-gray-600">Year: ${car.year} | ‚Çπ${car.daily_rate}/day</p>
                  <p class="text-xs text-gray-500">${car.location || 'N/A'}</p>
                </div>
              </div>
              <div class="flex gap-2 flex-col">
                <button class="btn btn-primary text-xs" onclick="viewCarBookings(${car.id}, '${car.brand} ${car.model}')">View Bookings</button>
                <button class="btn btn-danger text-xs" onclick="deleteCar(${car.id})">Delete</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Load cars error:', err);
        document.getElementById('carsList').innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
      }
    }

    // Delete Car
    async function deleteCar(id) {
      if (!confirm("Delete this car and all its bookings?")) return;

      try {
        console.log('Deleting car:', id);
        const res = await fetch(api('/api/deletecar'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAdminToken() },
          body: JSON.stringify({ car_id: id })
        });

        const text = await res.text();
        console.log('Delete response:', res.status, text);

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse delete response:', e);
          throw new Error('Invalid server response');
        }

        if (!res.ok) throw new Error(data.message || 'Failed to delete');

        showToast('‚úÖ Car deleted successfully!', 'success');
        loadCarList();
      } catch (err) {
        console.error('Delete car error:', err);
        showToast('‚ùå ' + err.message, 'error');
      }
    }

    // View Car Bookings
    async function viewCarBookings(carId, carName) {
      try {
        const res = await fetch(api(`/api/bookings/${carId}`), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });
        const bookings = await res.json();

        let html = `<h4 class="font-semibold mb-4">Bookings for ${carName}</h4>`;
        
        if (!bookings || bookings.length === 0) {
          html += '<p class="text-gray-500">No bookings for this car</p>';
        } else {
          html += '<div class="table-responsive"><table class="table"><thead><tr><th>Booking ID</th><th>Customer</th><th>From</th><th>To</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
          bookings.forEach(b => {
            html += `<tr><td>${b.id}</td><td>${b.customer_name || 'N/A'}</td><td>${new Date(b.start_date).toLocaleDateString()}</td><td>${new Date(b.end_date).toLocaleDateString()}</td><td>‚Çπ${b.amount || 0}</td><td><span class="badge badge-${b.status === 'confirmed' ? 'success' : 'warning'}">${b.status || 'pending'}</span></td></tr>`;
          });
          html += '</tbody></table></div>';
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `<div class="card w-full max-w-2xl">${html}<button class="btn btn-secondary mt-4 w-full" onclick="this.closest('.fixed').remove()">Close</button></div>`;
        document.body.appendChild(modal);
      } catch (err) {
        showToast('‚ùå ' + err.message, 'error');
      }
    }

    // QR Scanner Functions
    let scanning = false;
    let scannerInterval;

    document.getElementById('startScanBtn').addEventListener('click', () => {
      startScanner();
    });

    document.getElementById('stopScanBtn').addEventListener('click', () => {
      stopScanner();
    });

    async function startScanner() {
      try {
        const video = document.getElementById('video');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        scanning = true;
        document.getElementById('scanStatus').textContent = 'üé• Camera active - scanning...';

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        scannerInterval = setInterval(() => {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);

              if (code) {
                stopScanner();
                processQRCode(code.data);
              }
            } catch (err) {
              console.log('QR scan error:', err);
            }
          }
        }, 100);
      } catch (err) {
        showToast('‚ùå Camera access denied: ' + err.message, 'error');
        document.getElementById('scanStatus').textContent = '‚ùå Camera not available';
      }
    }

    function stopScanner() {
      scanning = false;
      const video = document.getElementById('video');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      clearInterval(scannerInterval);
      document.getElementById('scanStatus').textContent = 'Scanner stopped';
    }

    async function processQRCode(qrData) {
      try {
        // Parse QR data if it's JSON
        let parsedData = qrData;
        try {
          parsedData = JSON.parse(qrData);
        } catch (e) {
          // If not JSON, treat as booking_id
          parsedData = { booking_id: qrData, qr_type: 'collection' };
        }

        const res = await fetch(api('/api/admin/verify-qr'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAdminToken() },
          body: JSON.stringify({ qr_data: parsedData })
        });

        const result = await res.json();
        const resultDiv = document.getElementById('qrResult');

        if (res.ok) {
          resultDiv.innerHTML = `<div class="p-4 bg-green-50 border border-green-200 rounded-lg"><h4 class="font-semibold text-green-800">‚úÖ Verified</h4><p class="text-sm text-green-700 mt-2">${result.message || 'Verification successful'}</p></div>`;
          showToast('‚úÖ Payment verified!', 'success');
        } else {
          resultDiv.innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="font-semibold text-red-800">‚ùå Verification Failed</h4><p class="text-sm text-red-700 mt-2">${result.message || 'Failed to verify'}</p></div>`;
          showToast('‚ùå ' + result.message, 'error');
        }
      } catch (err) {
        console.error('QR processing error:', err);
        showToast('‚ùå Error: ' + err.message, 'error');
        document.getElementById('qrResult').innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg"><p class="text-sm text-red-700">Error: ${err.message}</p></div>`;
      }
    }

    // Load Schedule
    document.getElementById('viewScheduleBtn').addEventListener('click', async () => {
      const carId = document.getElementById('scheduleCarSelect').value;
      if (!carId) {
        showToast('Please select a car', 'error');
        return;
      }

      try {
        const res = await fetch(api(`/api/admin/car-schedule/${carId}`), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });

        const data = await res.json();
        const resultDiv = document.getElementById('scheduleResult');

        let html = '<h4 class="font-semibold mb-4">Car Schedule</h4>';

        if (data.bookings && data.bookings.length > 0) {
          html += '<div class="table-responsive"><table class="table"><thead><tr><th>Booking ID</th><th>From</th><th>To</th><th>Status</th></tr></thead><tbody>';
          data.bookings.forEach(b => {
            html += `<tr><td>${b.id}</td><td>${new Date(b.start_date).toLocaleDateString()}</td><td>${new Date(b.end_date).toLocaleDateString()}</td><td><span class="badge badge-${b.status === 'confirmed' ? 'success' : 'warning'}">${b.status}</span></td></tr>`;
          });
          html += '</tbody></table></div>';
        } else {
          html += '<p class="text-gray-500">No bookings scheduled</p>';
        }

        if (data.vacancies && data.vacancies.length > 0) {
          html += '<div class="mt-6"><h5 class="font-semibold mb-3">Available Dates (Next 180 Days)</h5>';
          data.vacancies.forEach(v => {
            html += `<div class="p-2 bg-green-50 border border-green-200 rounded text-sm mb-2">${v.start} ‚Üí ${v.end}</div>`;
          });
          html += '</div>';
        }

        resultDiv.innerHTML = html;
      } catch (err) {
        showToast('‚ùå ' + err.message, 'error');
      }
    });

    // Load schedule options on page load
    async function loadScheduleOptions() {
      try {
        const res = await fetch(api('/api/cars'));
        const cars = await res.json();
        const select = document.getElementById('scheduleCarSelect');
        select.innerHTML = '<option value="">Select a car...</option>';
        cars.forEach(car => {
          const option = document.createElement('option');
          option.value = car.id;
          option.textContent = `${car.brand} ${car.model} - ${car.location}`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Load schedule options error:', err);
      }
    }

    // Load cancellations
    async function loadCancellations() {
      try {
        const res = await fetch(api('/api/admin/canceled-bookings'), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });

        const cancellations = await res.json();
        const tbody = document.getElementById('cancellationsBody');

        if (!cancellations || cancellations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No cancellations</td></tr>';
          return;
        }

        tbody.innerHTML = cancellations.map(c => `
          <tr>
            <td>${c.booking_id}</td>
            <td>${c.customer_name || 'N/A'}</td>
            <td>${c.brand} ${c.model}</td>
            <td>${c.reason || 'N/A'}</td>
            <td>${new Date(c.cancelled_at).toLocaleDateString()}</td>
            <td><span class="badge badge-warning">${c.status || 'pending'}</span></td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Load cancellations error:', err);
      }
    }

    document.getElementById('processAllRefundsBtn').addEventListener('click', async () => {
      if (!confirm('Process all pending refunds?')) return;

      try {
        const res = await fetch(api('/api/admin/process-refunds'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAdminToken() }
        });

        const result = await res.json();
        if (res.ok) {
          showToast('‚úÖ ' + result.message, 'success');
          loadCancellations();
        } else {
          showToast('‚ùå ' + result.message, 'error');
        }
      } catch (err) {
        showToast('‚ùå ' + err.message, 'error');
      }
    });

    // Initialize
    if (getAdminToken()) {
      showSection('dashboard');
      loadDashboard();
      loadCarList();
      loadScheduleOptions();
      loadCancellations();
    } else {
      showSection('login');
    }
  </script>

  <script src="/video-bg.js" defer></script>
</body>
</html>
