<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .lb-backdrop { background: rgba(0,0,0,0.7); }

    /* --- Modern Sidebar UI Enhancements --- */
    .side-link {
      @apply flex items-center gap-2 w-full px-3 py-2 text-left text-sm rounded-md cursor-pointer transition-all;
    }
    .side-link:hover {
      @apply bg-gray-100;
    }
    .side-link.active {
      @apply bg-blue-600 text-white;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- üî∑ Top Navbar -->
  <header class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-blue-600 text-white flex items-center justify-center text-sm font-semibold">
          A6
        </div>
        <div class="font-semibold text-gray-800 text-lg">
          A6 Cars Admin
        </div>
      </div>

      <button id="admin-logout"
        class="hidden bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-4 py-2 rounded">
        Logout
      </button>
    </div>
  </header>

  <!-- Backend base -->
  <script>
    const BACKEND_URL =
      (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:3000'
        : 'https://a6cars-backend-ylx7.onrender.com';

    function api(path) {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        return path;
      return BACKEND_URL + path;
    }
  </script>

  <!-- ========================= MAIN BODY LAYOUT ========================= -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- Login card -->
    <div id="admin-login"
         class="max-w-md mx-auto bg-white rounded-lg shadow p-6 space-y-4">
      <h1 class="text-xl font-semibold text-center mb-2">Admin Login</h1>

      <input id="admin-email" type="text" placeholder="Admin Email"
             class="w-full p-3 border rounded" />

      <input id="admin-password" type="password" placeholder="Password"
             class="w-full p-3 border rounded" />

      <button id="admin-login-btn"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">
        Login
      </button>

      <div id="admin-login-msg"
           class="text-sm text-red-600 text-center"></div>
    </div>

    <!-- ========================= DASHBOARD ========================= -->
    <div id="admin-dashboard" class="hidden">

      <div class="flex flex-col lg:flex-row gap-6">

        <!-- üåô Modern Sidebar -->
        <aside class="w-full lg:w-72">
          <div class="bg-white rounded-lg shadow p-4 lg:sticky lg:top-28">

            <!-- Profile header -->
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-xl bg-blue-600 text-white flex items-center justify-center text-lg font-semibold">
                A6
              </div>
              <div>
                <div class="font-semibold text-gray-900 text-sm">A6 Admin</div>
                <div class="text-xs text-gray-500">Control Panel</div>
              </div>
            </div>

            <!-- üåê New Modern Sidebar Menu -->
            <div class="space-y-1 mb-6">

              <button class="side-link" data-section="section-addcar">
                üöó <span>Add Cars</span>
              </button>

              <button class="side-link" data-section="section-managecar">
                üõ† <span>Manage Cars</span>
              </button>

              <button class="side-link" data-section="section-verify">
                üì∑ <span>Verify Payment</span>
              </button>

              <button class="side-link" data-section="section-business">
                üè¢ <span>Business Details</span>
              </button>

              <button class="side-link" data-section="all">
                üìã <span>Show All</span>
              </button>

              <button class="side-link" data-section="section-cancellations">
                ‚ùå <span>Cancellations</span>
              </button>

              <button class="side-link" data-section="section-schedule">
                üìÖ <span>Car Schedule</span>
              </button>

            </div>

            <!-- Filters for Recent Transactions -->
            <div class="border-t pt-4 mt-4">
              <div class="text-sm font-semibold mb-2">Filters</div>

              <div class="space-y-2">
                <input id="filter-search" type="text" placeholder="Search"
                       class="w-full border rounded px-2 py-2 text-sm" />

                <div class="flex gap-2">
                  <input id="filter-from" type="date"
                         class="w-1/2 border rounded px-2 py-2 text-xs" />
                  <input id="filter-to" type="date"
                         class="w-1/2 border rounded px-2 py-2 text-xs" />
                </div>

                <div class="flex gap-2">
                  <button id="filter-apply"
                          class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm">
                    Apply
                  </button>

                  <button id="filter-clear"
                          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded text-sm">
                    Clear
                  </button>
                </div>
              </div>
            </div>

            <!-- Logout inside sidebar -->
            <button id="sidebar-logout"
              class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm font-medium">
              Logout
            </button>

          </div>
        </aside>

        <!-- ========================= MAIN CONTENT ========================= -->
        <section class="flex-1 space-y-6" id="admin-main">

          <!-- Dashboard quick stats -->
          <div class="bg-white rounded-lg shadow p-6">
            <h1 class="text-2xl font-bold mb-1">Admin Panel</h1>
            <p class="text-sm text-gray-500 mb-4">
              Manage cars, bookings and verify payments
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

              <div class="p-4 rounded shadow-sm bg-blue-50">
                <div class="text-sm text-gray-500">Total Bookings</div>
                <div id="stat-bookings" class="text-2xl font-bold">‚Äî</div>
              </div>

              <div class="p-4 rounded shadow-sm bg-yellow-50">
                <div class="text-sm text-gray-500">Pending Payments</div>
                <div id="stat-pending" class="text-2xl font-bold">‚Äî</div>
              </div>

              <div class="p-4 rounded shadow-sm bg-green-50">
                <div class="text-sm text-gray-500">Available Cars</div>
                <div id="stat-cars" class="text-2xl font-bold">‚Äî</div>
              </div>

            </div>
          </div><!-- ========================= ADD CAR SECTION ========================= -->
<section id="section-addcar" class="hidden">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-lg font-semibold mb-3">Add Car (Multiple Images)</h3>

    <form id="addCarForm" enctype="multipart/form-data" class="space-y-3">

      <input type="text" name="brand" placeholder="Brand" required
             class="w-full p-2 border rounded" />

      <input type="text" name="model" placeholder="Model" required
             class="w-full p-2 border rounded" />

      <input type="number" name="year" placeholder="Year" required
             class="w-full p-2 border rounded" />

      <input type="number" step="0.01" name="daily_rate"
             placeholder="Daily Rate (INR)" required
             class="w-full p-2 border rounded" />

      <input type="text" name="location" placeholder="Location" required
             class="w-full p-2 border rounded" />

      <label class="text-sm text-gray-600">Upload Images (JPG/JPEG)</label>
      <input type="file" name="images" id="images-input"
             accept=".jpg,.jpeg" multiple required
             class="w-full p-2 border rounded bg-gray-50" />

      <div id="images-preview"
           class="flex gap-2 mt-2 flex-wrap"></div>

      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white w-full p-2 rounded">
        Add Car
      </button>
    </form>
  </div>
</section>



<!-- ========================= MANAGE CARS SECTION ========================= -->
<section id="section-managecar" class="hidden">
  <div class="bg-white p-4 rounded shadow">

    <h3 class="text-lg font-semibold mb-3">Manage Cars</h3>

    <div id="car-list" class="space-y-3"></div>

    <!-- Bookings panel below each car -->
    <div id="car-bookings-panel"
         class="hidden mt-4 bg-gray-50 p-3 rounded">

      <div class="flex items-center justify-between mb-2">
        <h4 class="font-medium">
          Bookings for <span id="car-bookings-title"></span>
        </h4>

        <button id="close-car-bookings"
                class="text-xs bg-gray-200 px-2 py-1 rounded">
          Close
        </button>
      </div>

      <div class="overflow-auto">
        <table class="w-full text-left border-collapse text-xs">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">Booking ID</th>
              <th class="border px-2 py-1">Customer</th>
              <th class="border px-2 py-1">From</th>
              <th class="border px-2 py-1">To</th>
              <th class="border px-2 py-1">Amount</th>
              <th class="border px-2 py-1">Paid</th>
              <th class="border px-2 py-1">Verified</th>
            </tr>
          </thead>
          <tbody id="car-bookings-body"></tbody>
        </table>
      </div>

    </div>

  </div>
</section>


<!-- ========================= CANCELLATIONS SECTION ========================= -->
<section id="section-cancellations" class="hidden">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-lg font-semibold mb-3">Cancellations</h3>
    <div class="flex items-center gap-2 mb-3">
      <button id="process-refunds-all" class="bg-green-600 text-white px-3 py-1 rounded">Process Pending Refunds</button>
      <input id="process-refund-id" type="number" placeholder="Refund ID (optional)" class="border px-2 py-1 rounded text-sm" />
      <button id="process-refund-single" class="bg-blue-600 text-white px-3 py-1 rounded">Process Refund ID</button>
    </div>
    <div id="cancellations-list" class="text-sm text-gray-700">Loading...</div>
  </div>
</section>


<!-- ========================= CAR SCHEDULE SECTION ========================= -->
<section id="section-schedule" class="hidden">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-lg font-semibold mb-3">Car Schedule & Vacancies</h3>
    <div class="flex gap-2 mb-3">
      <select id="schedule-car-select" class="border p-2 rounded"></select>
      <button id="schedule-view" class="bg-blue-600 text-white px-3 py-1 rounded">View Schedule</button>
    </div>
    <div id="schedule-result" class="text-sm text-gray-700"></div>
  </div>
</section>


<!-- ========================= VERIFY PAYMENT SECTION ========================= -->
<section id="section-verify" class="hidden">
  <div class="bg-white rounded-lg shadow p-4" id="col-verify">

    <h3 class="text-lg font-semibold mb-3">Verify Payment (Scan QR)</h3>

    <div id="qr-result" class="mt-2 text-sm"></div>

    <div id="scanner" class="mt-4">
      <h4 class="font-medium mb-2 text-sm">Camera Scanner</h4>

      <video id="video" width="100%" height="220"
             class="border rounded"></video>

      <div id="scan-status"
           class="text-xs mt-2 text-gray-600"></div>

      <div class="mt-2 flex gap-2">

        <button id="start-scan"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
          Start Scan
        </button>

        <button id="stop-scan"
                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
          Stop Scan
        </button>

      </div>
    </div>

  </div>
</section>



<!-- ========================= BUSINESS DETAILS SECTION ========================= -->
<section id="section-business" class="hidden">
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold mb-3">Business Details</h3>

    <p class="text-sm text-gray-600">
      Add GST, company information, legal details and settings here later.
    </p>
  </div>
</section><!-- ========================= RECENT TRANSACTIONS SECTION ========================= -->
<section id="section-transactions">
  <div class="bg-white rounded-lg shadow p-4">

    <h3 class="text-lg font-semibold mb-3">Recent Transactions</h3>
    <p class="text-xs text-gray-500 mb-2">
      Showing up to 10 most recent bookings/payments.
    </p>

    <div class="overflow-auto">
      <table id="tx-table" class="w-full text-left text-sm border-collapse">

        <thead class="bg-gray-50">
          <tr>
            <th class="border px-2 py-1">Payment ID</th>
            <th class="border px-2 py-1">Customer</th>
            <th class="border px-2 py-1">Car</th>
            <th class="border px-2 py-1">From</th>
            <th class="border px-2 py-1">To</th>
            <th class="border px-2 py-1">Amount</th>
            <th class="border px-2 py-1">Paid</th>
            <th class="border px-2 py-1">Verified</th>
          </tr>
        </thead>

        <tbody id="tx-body">
          <!-- JS renders latest 10 transactions -->
        </tbody>

      </table>
    </div>

  </div>
</section>



<!-- ========================= LIGHTBOX ‚Äî IMG VIEWER ========================= -->
<div id="lightbox"
     class="fixed inset-0 hidden items-center justify-center z-50">

  <div id="lb-backdrop"
       class="absolute inset-0 lb-backdrop"></div>

  <div class="relative z-50 max-w-3xl w-full mx-4">

    <div class="bg-white rounded p-4 shadow-xl">

      <div class="flex justify-between items-center mb-2">
        <div id="lb-title" class="font-semibold">Images</div>

        <button id="lb-close"
                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
          Close
        </button>
      </div>

      <div id="lb-images"
           class="flex gap-2 overflow-x-auto"></div>

    </div>

  </div>
</div><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
/* ============================================================
   AUTH HELPERS
============================================================ */
function getAdminToken() {
  return sessionStorage.getItem('adminToken') || '';
}

function setAdminToken(token) {
  sessionStorage.setItem('adminToken', token);
  sessionStorage.setItem('adminLoggedIn', '1');

  document.getElementById('admin-login').classList.add('hidden');
  document.getElementById('admin-dashboard').classList.remove('hidden');
  document.getElementById('admin-logout').classList.remove('hidden');

    loadCarList();
    loadTransactions();
    ensureAdminExtras();
}

function doLogout() {
  sessionStorage.clear();
  stopScan();

  document.getElementById('admin-dashboard').classList.add('hidden');
  document.getElementById('admin-login').classList.remove('hidden');
  document.getElementById('admin-logout').classList.add('hidden');
}


/* ============================================================
   ADMIN LOGIN
============================================================ */
document.getElementById('admin-login-btn').addEventListener('click', async () => {
  const email = document.getElementById('admin-email').value.trim();
  const password = document.getElementById('admin-password').value;
  const msg = document.getElementById('admin-login-msg');

  msg.innerText = '';

  try {
    const res = await fetch(api('/api/admin/login'), {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, password })
    });

    const txt = await res.text();
    let j = {};
    try { j = JSON.parse(txt); } catch {}

    if (!res.ok) throw new Error(j.message || 'Login failed');

    setAdminToken(j.token);
  }
  catch(err) {
    msg.innerText = err.message;
  }
});

document.getElementById('admin-logout').addEventListener('click', doLogout);
document.getElementById('sidebar-logout').addEventListener('click', doLogout);


/* ============================================================
   SIDEBAR SECTION SWITCHER + ACTIVE BUTTON
============================================================ */
const sectionIds = [
  'section-addcar',
  'section-managecar',
  'section-verify',
  'section-business',
  'section-cancellations',
  'section-schedule'
];

document.querySelectorAll('.side-link').forEach(btn => {
  btn.addEventListener('click', () => {
    const section = btn.dataset.section;

    // active highlight
    document.querySelectorAll('.side-link').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    showSection(section);
  });
});

// Start / Stop scan button bindings
const _startScanBtn = document.getElementById('start-scan');
const _stopScanBtn = document.getElementById('stop-scan');
if (_startScanBtn) _startScanBtn.addEventListener('click', (e) => { e.preventDefault(); startScan(); });
if (_stopScanBtn) _stopScanBtn.addEventListener('click', (e) => { e.preventDefault(); stopScan(); });

function showSection(which) {
  if (which === 'all') {
    sectionIds.forEach(id => document.getElementById(id).classList.remove('hidden'));
  } else {
    sectionIds.forEach(id => {
      document.getElementById(id).classList.toggle('hidden', id !== which);
    });
  }

  if (which === 'section-verify' || which === 'all') startScan();

  document.getElementById('admin-main')
    .scrollIntoView({ behavior:'smooth', block:'start' });
}


/* ============================================================
   ADD CAR ‚Äî MULTIPLE IMAGES
============================================================ */
const imagesInput = document.getElementById('images-input');
const imagesPreview = document.getElementById('images-preview');

imagesInput.addEventListener('change', function() {
  imagesPreview.innerHTML = '';
  Array.from(this.files).forEach(file => {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    img.className = 'w-28 h-20 object-cover rounded border';
    imagesPreview.appendChild(img);
  });
});

document.getElementById('addCarForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const token = getAdminToken();
  if (!token) return alert("Please login as admin");

  const fd = new FormData(this);

  try {
    const res = await fetch(api('/api/admin/addcar'), {
      method: 'POST',
      headers: { 'Authorization':'Bearer '+token },
      body: fd
    });

    const txt = await res.text();
    let j = {};
    try { j = JSON.parse(txt);} catch {}

    if (!res.ok) throw new Error(j.message);

    alert("Car added successfully!");

    this.reset();
    imagesPreview.innerHTML = '';
    loadCarList();
  }
  catch(err) {
    alert(err.message);
  }
});


/* ============================================================
   LOAD ALL CARS + DELETE + VIEW BOOKINGS
============================================================ */
async function loadCarList() {
  try {
    const token = getAdminToken();
    const headers = token ? {Authorization:'Bearer '+token} : {};

    const res = await fetch(api('/api/cars'), { headers });
    const list = await res.json();

    const carList = document.getElementById('car-list');
    carList.innerHTML = '';

    if (!list.length) {
      carList.innerHTML = `<div class="text-gray-500 text-sm">No cars found.</div>`;
      document.getElementById('stat-cars').innerText = '0';
      return;
    }

    document.getElementById('stat-cars').innerText = list.length;

    list.forEach(car => {
      const imgs = (car.images || []).map(u =>
        u.startsWith('http') ? u : BACKEND_URL + '/' + u
      );

      const thumb = imgs[0] || 'https://via.placeholder.com/160x100?text=No+Image';

      const div = document.createElement('div');
      div.className = "border rounded p-3 bg-white flex justify-between items-center";

      div.innerHTML = `
        <div class="flex gap-4 items-center">
          <img src="${thumb}" class="w-32 h-20 rounded border cursor-pointer"
               data-images='${JSON.stringify(imgs)}'>

          <div class="text-sm">
            <div class="font-semibold">${car.brand} ${car.model}</div>
            <div class="text-xs text-gray-600">Year: ${car.year} | ‚Çπ${car.daily_rate}/day</div>
            <div class="text-xs text-gray-400">${car.location || ''}</div>
          </div>
        </div>

        <div class="flex flex-col gap-1 text-xs">
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded view-bookings"
                  data-carid="${car.id}" data-carname="${car.brand} ${car.model}">
            View Bookings
          </button>
          <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded delete-car"
                  data-carid="${car.id}">
            Delete
          </button>
        </div>
      `;

      carList.appendChild(div);

      div.querySelector('img').addEventListener('click', () => {
        openLightbox(imgs, `${car.brand} ${car.model}`);
      });

      div.querySelector('.view-bookings').addEventListener('click', () => {
        viewCarBookings(car.id, `${car.brand} ${car.model}`);
      });

      div.querySelector('.delete-car').addEventListener('click', () => deleteCar(car.id));
    });

  } catch(err) {
    console.error(err);
  }
}

async function deleteCar(id) {
  if (!confirm("Delete this car and its bookings?")) return;

  const token = getAdminToken();
 const headers = {
    'Content-Type':'application/json',
    'Authorization':'Bearer '+token
  };

  const res = await fetch(api('/api/deletecar'), {
    method:'POST',
    headers,
    body: JSON.stringify({ car_id:id })
  });

  const j = await res.json();
  alert(j.message || "Deleted");
  loadCarList();
}


/* ============================================================
   VIEW BOOKINGS PER CAR (FULLY FIXED)
============================================================ */
function viewCarBookings(carId, carName) {
  const panel = document.getElementById('car-bookings-panel');
  const title = document.getElementById('car-bookings-title');
  const body = document.getElementById('car-bookings-body');

  title.textContent = carName;
  panel.classList.remove('hidden');

  body.innerHTML = `<tr><td colspan="8" class="text-gray-500 text-xs p-2">Loading...</td></tr>`;

  const token = getAdminToken();

  fetch(api(`/api/bookings/${carId}`), {
    headers: token ? { Authorization:'Bearer '+token } : {}
  })
  .then(r => r.json())
  .then(list => {
    body.innerHTML = '';

    if (!list.length) {
      body.innerHTML = `<tr><td colspan="8" class="text-gray-500 text-xs p-2">No bookings found.</td></tr>`;
      return;
    }

    list.forEach(bk => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="border px-2 py-1">${bk.booking_id ?? bk.id ?? '‚Äî'}</td>
        <td class="border px-2 py-1">${bk.customer_name || bk.name || bk.email || ''}</td>
        <td class="border px-2 py-1">${new Date(bk.start_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">${new Date(bk.end_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">${bk.amount ? '‚Çπ'+bk.amount : '-'}</td>

        <td class="border px-2 py-1">
          ${(bk.paid==1 || bk.is_paid==1 || bk.payment_status==1) ? 'Yes' : 'No'}
        </td>

        <td class="border px-2 py-1">
          ${(bk.verified==1 || bk.is_verified==1 || bk.verification_status==1) ? 'Yes' : 'No'}
        </td>
      `;

      // Action cell
      const actionTd = document.createElement('td');
      actionTd.className = 'border px-2 py-1';
      if (bk.status === 'cancelled') {
        actionTd.innerHTML = '<span class="text-red-600 font-semibold">Cancelled</span>';
      } else {
        const btn = document.createElement('button');
        btn.className = 'bg-red-500 text-white px-2 py-1 rounded admin-cancel';
        btn.dataset.booking = bk.id;
        btn.innerText = 'Cancel';
        actionTd.appendChild(btn);
      }

      body.appendChild(tr);
      tr.appendChild(actionTd);
    });

    // attach listeners for cancel buttons
    body.querySelectorAll('.admin-cancel').forEach(btn => {
      btn.addEventListener('click', async () => {
        const bookingId = btn.dataset.booking;
        const reason = prompt('Enter reason for cancellation:');
        if (!reason) return alert('Cancellation reason required');

        try {
          const res = await fetch(api('/api/admin/cancel-booking'), {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+getAdminToken() },
            body: JSON.stringify({ booking_id: bookingId, reason })
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.message || 'Cancel failed');
          alert(j.message);
          viewCarBookings(carId, carName);
          loadCancellations();
        } catch (err) {
          alert('Error cancelling booking: ' + err.message);
        }
      });
    });
  });
}

document.getElementById('close-car-bookings')
  .addEventListener('click', () => {
    document.getElementById('car-bookings-panel').classList.add('hidden');
  });


/* ============================================================
   RECENT TRANSACTIONS (ONLY LATEST 10)
============================================================ */
let allTransactions = [];

async function loadTransactions() {
  try {
    const res = await fetch(api('/api/admin/transactions?page=1&pageSize=50'), {
      headers: {Authorization:'Bearer '+getAdminToken()}
    });

    const data = await res.json();
    allTransactions = data.data || [];

    renderTransactions();

    // Stats
    // Total bookings shown
    document.getElementById('stat-bookings').innerText = allTransactions.length;

    // Pending = those not marked paid. Accept both boolean true and numeric 1 as paid markers.
    document.getElementById('stat-pending').innerText =
      allTransactions.filter(tx => !(tx.paid === true || tx.paid == 1)).length;
  }
  catch(err) { console.log(err); }
}

function renderTransactions() {
  const body = document.getElementById('tx-body');
  body.innerHTML = '';

  // Sort by latest
  allTransactions.sort((a,b) =>
    new Date(b.start_date) - new Date(a.start_date)
  );

  const latest10 = allTransactions.slice(0,10);

  latest10.forEach(tx => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td class="border px-2 py-1">${tx.payment_id ?? tx.id ?? '-'}</td>
      <td class="border px-2 py-1">${tx.customer_name || tx.name || 'Unknown'}</td>
      <td class="border px-2 py-1">${tx.brand || ''} ${tx.model || ''}</td>
      <td class="border px-2 py-1">${tx.start_date ? new Date(tx.start_date).toLocaleDateString() : '-'}</td>
      <td class="border px-2 py-1">${tx.end_date ? new Date(tx.end_date).toLocaleDateString() : '-'}</td>
      <td class="border px-2 py-1">‚Çπ${tx.amount || 0}</td>
      <td class="border px-2 py-1">${(tx.paid==true || tx.paid==1) ? 'Yes' : 'No'}</td>
      <td class="border px-2 py-1">${(tx.verified==true || tx.verified==1) ? 'Yes' : 'No'}</td>
    `;

    body.appendChild(tr);
  });
}


/* ============================================================
   LIGHTBOX IMAGE VIEWER
============================================================ */
function openLightbox(images, title) {
  const lb = document.getElementById('lightbox');
  const lbImgs = document.getElementById('lb-images');
  const lbTitle = document.getElementById('lb-title');

  lbImgs.innerHTML = '';
  lbTitle.textContent = title;

  images.forEach(url => {
    const img = document.createElement('img');
    img.src = url;
    img.className = 'max-h-96 object-contain mr-2';
    lbImgs.appendChild(img);
  });

  lb.classList.remove('hidden');
  lb.classList.add('flex');
}

document.getElementById('lb-close').addEventListener('click', () => {
  document.getElementById('lightbox').classList.add('hidden');
  document.getElementById('lightbox').classList.remove('flex');
});


/* ============================================================
   QR SCANNER + VERIFY PAYMENT
============================================================ */
let videoStream = null;

async function startScan() {
  const video = document.getElementById('video');
  if (!video) return;

  const status = document.getElementById('scan-status');
  status.innerText = "Starting camera...";

  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
    video.srcObject = videoStream;
    video.play();

    status.innerText = "Scanning...";

    // BarcodeDetector first
    if (window.BarcodeDetector) {
      try {
        const detector = new BarcodeDetector({formats:['qr_code']});
        const loop = async () => {
          const codes = await detector.detect(video).catch(()=>[]);
          if (codes.length) {
            stopScan();
            verifyQrToken(codes[0].rawValue);
            return;
          }
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
        return;
      } catch {}
    }

    // jsQR fallback
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const scanLoop = () => {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video,0,0);

        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(img.data,img.width,img.height);

        if (code && code.data) {
          stopScan();
          verifyQrToken(code.data);
          return;
        }
      }
      requestAnimationFrame(scanLoop);
    };

    requestAnimationFrame(scanLoop);
  }
  catch(err) {
    status.innerText = "Camera failed or permission blocked.";
  }
}

function stopScan() {
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
  const video = document.getElementById('video');
  if (video) video.srcObject = null;
}

async function verifyQrToken(token) {
  const status = document.getElementById('scan-status');

  const t = getAdminToken();
  if (!t) return status.innerText = "Admin not logged in";

  let qr_data = {};
  try { qr_data = JSON.parse(token); }
  catch { qr_data = { booking_id: token }; }

  try {
    const res = await fetch(api('/api/admin/verify-qr'), {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+t
      },
      body: JSON.stringify({qr_data})
    });

    const j = await res.json();

    if (!res.ok) throw new Error(j.message || 'Verification failed');

    playSuccessSound();
    showToast("Booking Verified!", "green");

    // The backend returns { message, qr_verification: { booking_id, customer, booking, car, ... } }
    const v = j.qr_verification || {};
    const bookingId = v.booking_id || v.booking?.booking_id || v.booking?.id || '-';
    const customerName = v.customer?.name || v.customer?.customer_name || '-';
    const carLabel = v.car?.model || v.car || (v.booking ? `${v.booking.brand || ''} ${v.booking.model || ''}` : '-');
    const amount = v.booking?.amount ?? v.amount ?? '-';

    document.getElementById('qr-result').innerHTML = `
      <div class="bg-green-50 border border-green-300 p-3 rounded mt-2 text-sm">
        <p><b>Booking ID:</b> ${bookingId}</p>
        <p><b>Customer:</b> ${customerName}</p>
        <p><b>Car:</b> ${carLabel}</p>
        <p><b>Amount:</b> ‚Çπ${amount}</p>
      </div>
    `;
    // Show vacancies when returned by server (early-return case)
    if (v.vacancies && v.vacancies.length) {
      const vacHtml = `<div class="mt-3 p-3 bg-yellow-50 rounded text-sm"><h4 class="font-semibold">Available ranges (now ‚Üí booking end)</h4>` + v.vacancies.map(r => `<div>${r.start} ‚Üí ${r.end}</div>`).join('') + `</div>`;
      document.getElementById('qr-result').innerHTML += vacHtml;
    }

    loadCarList();
    loadTransactions();
  }
  catch(err) {
    showToast(err.message, "red");
    status.innerText = "Verification failed";
  }
}


/* ============================================================
   UTILITIES
============================================================ */
function showToast(msg, color) {
  const div = document.createElement("div");

  div.style.position = "fixed";
  div.style.top = "16px";
  div.style.right = "16px";
  div.style.padding = "10px 14px";
  div.style.borderRadius = "6px";
  div.style.zIndex = "99999";
  div.style.color = "white";

  div.style.background =
    color === "green" ? "#16a34a" :
    color === "red"   ? "#dc2626" : "#4b5563";

  div.innerText = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

function playSuccessSound() {
  new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_2bda1e560f.mp3").play().catch(()=>{});
}


/* ============================================================
   CANCELLATIONS & SCHEDULE HELPERS
============================================================ */

// Load cancellations list into the Cancellations section
async function loadCancellations() {
  try {
    const token = getAdminToken();
    if (!token) return;
    const res = await fetch(api('/api/admin/canceled-bookings'), { headers: { Authorization: 'Bearer ' + token } });
    const list = await res.json();
    const container = document.getElementById('cancellations-list');
    if (!container) return;

    if (!list.length) {
      container.innerHTML = `<p class="text-sm text-gray-500">No cancellations yet.</p>`;
      return;
    }

    let html = `<div class="overflow-auto"><table class="w-full text-left text-sm border-collapse"><thead class="bg-gray-50"><tr><th class="border px-2 py-1">Booking</th><th class="border px-2 py-1">Customer</th><th class="border px-2 py-1">Car</th><th class="border px-2 py-1">From</th><th class="border px-2 py-1">To</th><th class="border px-2 py-1">Reason</th><th class="border px-2 py-1">Cancelled At</th></tr></thead><tbody>`;
    list.forEach(r => {
      html += `<tr><td class="border px-2 py-1">${r.booking_id}</td><td class="border px-2 py-1">${r.customer_name}</td><td class="border px-2 py-1">${r.brand} ${r.model}</td><td class="border px-2 py-1">${new Date(r.start_date).toLocaleDateString()}</td><td class="border px-2 py-1">${new Date(r.end_date).toLocaleDateString()}</td><td class="border px-2 py-1">${r.reason}</td><td class="border px-2 py-1">${new Date(r.cancelled_at).toLocaleString()}</td></tr>`;
    });
    html += `</tbody></table></div>`;
    container.innerHTML = html;
  } catch (err) {
    console.error('Load cancellations error:', err);
  }
}

// Load car options for schedule view
async function loadScheduleOptions() {
  try {
    const res = await fetch(api('/api/cars'));
    const cars = await res.json();
    const sel = document.getElementById('schedule-car-select');
    if (!sel) return;
    sel.innerHTML = '';
    cars.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.text = `${c.brand} ${c.model} (${c.location || ''})`;
      sel.appendChild(opt);
    });
  } catch (err) { console.error('Load schedule options error:', err); }
}

document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'schedule-view') {
    const sel = document.getElementById('schedule-car-select');
    if (sel && sel.value) showCarSchedule(sel.value);
  }
});

// Render car schedule and vacancies
async function showCarSchedule(carId) {
  try {
    const token = getAdminToken();
    const res = await fetch(api(`/api/admin/car-schedule/${carId}`), { headers: { Authorization: 'Bearer ' + token } });
    if (!res.ok) throw new Error('Failed to load schedule');
    const data = await res.json();

    const out = document.getElementById('schedule-result');
    out.innerHTML = '';

    const bookings = data.bookings || [];
    if (!bookings.length) {
      out.innerHTML = `<p class="text-sm text-gray-500">No bookings for this car.</p>`;
    } else {
      const tbl = document.createElement('div');
      tbl.innerHTML = `<div class="overflow-auto"><table class="w-full text-left text-sm border-collapse"><thead class="bg-gray-50"><tr><th class="border px-2 py-1">Booking ID</th><th class="border px-2 py-1">From</th><th class="border px-2 py-1">To</th><th class="border px-2 py-1">Status</th></tr></thead><tbody>${bookings.map(b=>`<tr><td class="border px-2 py-1">${b.id}</td><td class="border px-2 py-1">${new Date(b.start_date).toLocaleDateString()}</td><td class="border px-2 py-1">${new Date(b.end_date).toLocaleDateString()}</td><td class="border px-2 py-1">${b.status}</td></tr>`).join('')}</tbody></table></div>`;
      out.appendChild(tbl);
    }

    // vacancies
    const vac = data.vacancies || [];
    if (vac.length) {
      const vdiv = document.createElement('div');
      vdiv.className = 'mt-3 p-3 bg-gray-50 rounded';
      vdiv.innerHTML = `<h4 class="font-semibold">Vacancies (next 180 days)</h4>` + vac.map(v => `<div class="text-sm">${v.start} ‚Üí ${v.end}</div>`).join('');
      out.appendChild(vdiv);
    } else {
      const vdiv = document.createElement('div');
      vdiv.className = 'mt-3 text-sm text-gray-500';
      vdiv.innerText = 'No vacancy ranges (car fully free or fully booked in window).';
      out.appendChild(vdiv);
    }
  } catch (err) {
    console.error('showCarSchedule error:', err);
    document.getElementById('schedule-result').innerHTML = `<p class="text-red-600">${err.message}</p>`;
  }
}

// When admin dashboard becomes visible, load cancellations and schedule options
function ensureAdminExtras() {
  loadCancellations();
  loadScheduleOptions();
}

// Handle refund processing actions
document.addEventListener('click', async (e) => {
  if (e.target && e.target.id === 'process-refunds-all') {
    if (!confirm('Process all pending refunds? This will mark them as processed (simulated).')) return;
    try {
      const res = await fetch(api('/api/admin/process-refunds'), {
        method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+getAdminToken() }
      });
      const j = await res.json();
      if (!res.ok) throw new Error(j.message || 'Processing failed');
      alert(j.message + '\nProcessed: ' + (j.processed ? j.processed.length : 0));
      loadCancellations();
    } catch (err) { alert('Error: '+err.message); }
  }

  if (e.target && e.target.id === 'process-refund-single') {
    const id = document.getElementById('process-refund-id').value;
    if (!id) return alert('Enter a refund ID to process');
    try {
      const res = await fetch(api('/api/admin/process-refunds'), {
        method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+getAdminToken() },
        body: JSON.stringify({ refund_id: parseInt(id,10) })
      });
      const j = await res.json();
      if (!res.ok) throw new Error(j.message || 'Processing failed');
      alert(j.message);
      loadCancellations();
    } catch (err) { alert('Error: '+err.message); }
  }
});

/* ============================================================
   AUTO-LOGIN RESTORE
============================================================ */
(function init() {
  if (getAdminToken()) {
    document.getElementById('admin-login').classList.add('hidden');
    document.getElementById('admin-dashboard').classList.remove('hidden');
    document.getElementById('admin-logout').classList.remove('hidden');

    loadCarList();
    loadTransactions();
    ensureAdminExtras();
  }
})();
</script>
  </body>
  </html>
