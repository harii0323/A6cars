<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel | A6 Cars</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/video-bg.css">

  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --light: #f8fafc;
      --border: #e2e8f0;
      --text-dark: #1e293b;
      --text-light: #64748b;
    }

    * {
      transition: all 0.25s ease;
    }

    body {
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      color: var(--text-dark);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    /* ======== NAVBAR ======== */
    header {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
      position: sticky;
      top: 0;
      z-index: 40;
      border-bottom: 1px solid var(--border);
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--text-dark);
    }

    .navbar-logo {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 800;
      font-size: 1.1rem;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    /* ======== SIDEBAR ======== */
    .sidebar {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      border-right: 1px solid var(--border);
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.06);
    }

    .sidebar-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--text-light);
      cursor: pointer;
      border-left: 3px solid transparent;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 10px;
      margin: 4px 8px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar-menu-item:hover {
      background: rgba(37, 99, 235, 0.08);
      color: var(--primary);
      border-left-color: var(--primary);
      transform: translateX(4px);
    }

    .sidebar-menu-item.active {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.15) 0%, rgba(37, 99, 235, 0.05) 100%);
      color: var(--primary);
      border-left-color: var(--primary);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }

    .sidebar-menu-item i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }

    /* ======== CARDS ======== */
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      padding: 24px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title i {
      color: var(--primary);
    }

    /* ======== STAT CARDS ======== */
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 2px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      background: rgba(37, 99, 235, 0.05);
      border-radius: 50%;
      transform: translate(30%, -30%);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .stat-card.success {
      border-color: rgba(16, 185, 129, 0.2);
    }

    .stat-card.success::before {
      background: rgba(16, 185, 129, 0.05);
    }

    .stat-card.warning {
      border-color: rgba(245, 158, 11, 0.2);
    }

    .stat-card.warning::before {
      background: rgba(245, 158, 11, 0.05);
    }

    .stat-card.danger {
      border-color: rgba(239, 68, 68, 0.2);
    }

    .stat-card.danger::before {
      background: rgba(239, 68, 68, 0.05);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
      margin-bottom: 8px;
      display: block;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-dark);
      margin: 8px 0;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ======== BUTTONS ======== */
    .btn {
      padding: 11px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
      transition: all 0.25s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .btn-primary:hover {
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
    }

    .btn-success:hover {
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
    }

    .btn-danger:hover {
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--light) 0%, #e2e8f0 100%);
      color: var(--text-dark);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: #e2e8f0;
      border-color: var(--primary);
      color: var(--primary);
    }

    /* ======== FORMS ======== */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 18px;
    }

    .form-label {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.95rem;
    }

    .form-control {
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      font-family: inherit;
      background: white;
      color: var(--text-dark);
      transition: all 0.25s ease;
    }

    .form-control::placeholder {
      color: var(--text-light);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
    }

    .form-control:disabled {
      background: var(--light);
      color: var(--text-light);
      cursor: not-allowed;
    }

    /* ======== TABLES ======== */
    .table-responsive {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .table thead {
      background: linear-gradient(135deg, #f8fafc 0%, #f0f4f8 100%);
    }

    .table th {
      padding: 14px;
      text-align: left;
      font-weight: 700;
      color: var(--text-dark);
      border-bottom: 2px solid var(--border);
      text-transform: uppercase;
      letter-spacing: 0.02em;
      font-size: 0.8rem;
    }

    .table td {
      padding: 14px;
      border-bottom: 1px solid var(--border);
      color: var(--text-light);
    }

    .table tr:hover {
      background: rgba(37, 99, 235, 0.03);
    }

    .table tbody tr {
      transition: all 0.2s ease;
    }

    /* ======== BADGES ======== */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.15);
      color: #047857;
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.15);
      color: #b45309;
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.15);
      color: #991b1b;
    }

    .badge-info {
      background: rgba(59, 130, 246, 0.15);
      color: #1e40af;
    }

    /* ======== LOGIN PAGE ======== */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 420px;
      border: 1px solid var(--border);
      animation: slideUp 0.4s ease;
    }

    .login-logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 24px;
      border-radius: 15px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.8rem;
      font-weight: 800;
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
    }

    /* ======== MODALS & OVERLAYS ======== */
    .sidebar-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal {
      backdrop-filter: blur(4px);
      background: rgba(0, 0, 0, 0.6);
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border);
    }

    /* ======== ANIMATIONS ======== */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .card {
      animation: slideUp 0.3s ease;
    }

    .toast {
      animation: slideIn 0.3s ease;
    }

    /* ======== RESPONSIVE DESIGN ======== */
    @media (max-width: 1024px) {
      .sidebar {
        width: 260px;
      }
    }

    @media (max-width: 768px) {
      body {
        font-size: 14px;
      }

      .card {
        padding: 18px;
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 1.1rem;
      }

      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .stat-value {
        font-size: 2rem;
      }

      .stat-label {
        font-size: 0.8rem;
      }

      .table {
        font-size: 0.85rem;
      }

      .table th,
      .table td {
        padding: 12px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 0.85rem;
      }

      .login-card {
        padding: 30px 20px;
      }

      .form-control {
        padding: 11px 12px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 16px;
        border-radius: 12px;
      }

      .card-title {
        font-size: 1rem;
      }

      .stat-value {
        font-size: 1.75rem;
      }

      .stat-label {
        font-size: 0.75rem;
      }

      .login-card {
        padding: 24px 16px;
      }

      .table {
        font-size: 0.75rem;
      }

      .table th,
      .table td {
        padding: 10px;
      }

      .btn {
        padding: 9px 14px;
        font-size: 0.8rem;
        gap: 6px;
      }

      .btn i {
        font-size: 0.85rem;
      }

      header {
        padding: 12px 16px !important;
      }

      .navbar-brand {
        font-size: 1rem;
        gap: 8px;
      }

      .navbar-logo {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
    }

    /* ======== SCROLLBAR ======== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--light);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* ======== UTILITY CLASSES ======== */
    .text-primary {
      color: var(--primary);
    }

    .text-danger {
      color: var(--danger);
    }

    .text-success {
      color: var(--success);
    }

    .text-light {
      color: var(--text-light);
    }

    .bg-light {
      background: var(--light);
    }

    .border-light {
      border-color: var(--border);
    }
  </style>
</head>

<body class="bg-gray-100">

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar Navigation -->
  <aside class="sidebar" id="sidebar">
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 text-white flex items-center justify-center text-lg font-bold">
          A6
        </div>
        <div>
          <h1 class="font-bold text-gray-900">A6 Cars</h1>
          <p class="text-xs text-gray-500">Admin Panel</p>
        </div>
      </div>
    </div>

    <nav class="py-4">
      <div class="px-4 py-2">
        <p class="text-xs font-semibold text-gray-400 uppercase">Main</p>
      </div>

      <div class="sidebar-menu-item active" data-section="dashboard">
        <i class="fas fa-dashboard"></i>
        <span>Dashboard</span>
      </div>

      <div class="px-4 py-2 mt-4">
        <p class="text-xs font-semibold text-gray-400 uppercase">Manage</p>
      </div>

      <div class="sidebar-menu-item" data-section="add-car">
        <i class="fas fa-plus-circle"></i>
        <span>Add Car</span>
      </div>

      <div class="sidebar-menu-item" data-section="manage-cars">
        <i class="fas fa-car"></i>
        <span>Manage Cars</span>
      </div>

      <div class="sidebar-menu-item" data-section="schedule">
        <i class="fas fa-calendar-alt"></i>
        <span>Schedule</span>
      </div>

      <div class="px-4 py-2 mt-4">
        <p class="text-xs font-semibold text-gray-400 uppercase">Finance</p>
      </div>

      <div class="sidebar-menu-item" data-section="verify-payment">
        <i class="fas fa-check-circle"></i>
        <span>Verify Payment</span>
      </div>

      <div class="sidebar-menu-item" data-section="cancellations">
        <i class="fas fa-ban"></i>
        <span>Cancellations</span>
      </div>

      <div class="px-4 py-2 mt-4">
        <p class="text-xs font-semibold text-gray-400 uppercase">Other</p>
      </div>

      <div class="sidebar-menu-item" data-section="business">
        <i class="fas fa-cog"></i>
        <span>Business Details</span>
      </div>

      <div class="border-t mt-4 pt-4 px-4">
       <!-- <button class="w-full btn btn-danger text-sm justify-center" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>-->
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="lg:ml-[280px] min-h-screen">
    <!-- Top Navbar -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
      <div class="px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>
          <h2 class="text-xl font-bold text-gray-900" id="pageTitle">Dashboard</h2>
        </div>
        <div class="flex items-center gap-4">
          <button class="btn btn-danger hidden" id="topLogoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Login Section -->
    <div id="loginSection" class="min-h-screen flex items-center justify-center px-4 py-8">
      <div class="card max-w-md w-full">
        <div class="text-center mb-8">
          <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 text-white flex items-center justify-center text-3xl font-bold mx-auto mb-4">
            A6
          </div>
          <h1 class="text-2xl font-bold text-gray-900">Admin Login</h1>
          <p class="text-sm text-gray-500 mt-2">Secure Access</p>
        </div>

        <form id="loginForm" class="space-y-4">
          <div class="form-group">
            <label class="form-label">Email Address</label>
            <input id="adminEmail" type="email" class="form-control" placeholder="admin@example.com" required>
          </div>

          <div class="form-group">
            <label class="form-label">Password</label>
            <input id="adminPassword" type="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          </div>

          <button type="submit" class="btn btn-primary w-full justify-center mt-6">
            <i class="fas fa-lock"></i>
            Sign In
          </button>

          <div id="loginError" class="p-3 bg-red-50 text-red-600 text-sm rounded-lg hidden"></div>
        </form>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="hidden">
      <div class="px-6 py-8">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <div class="stat-card">
            <div class="stat-label">Total Bookings</div>
            <div class="stat-value" id="statBookings">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">All time bookings</p>
          </div>

          <div class="stat-card warning">
            <div class="stat-label">Pending Payments</div>
            <div class="stat-value" id="statPending">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">Awaiting verification</p>
          </div>

          <div class="stat-card success">
            <div class="stat-label">Available Cars</div>
            <div class="stat-value" id="statCars">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">Ready to rent</p>
          </div>

          <div class="stat-card danger">
            <div class="stat-label">Cancellations</div>
            <div class="stat-value" id="statCancellations">‚Äî</div>
            <p class="text-xs text-gray-500 mt-2">Pending refunds</p>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
          <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">Recent Transactions</h3>
            <button class="btn btn-secondary text-xs">
              <i class="fas fa-refresh"></i> Refresh
            </button>
          </div>

          <div class="table-responsive">
            <table class="table" id="recentTransactionsTable">
              <thead>
                <tr>
                  <th>Payment ID</th>
                  <th>Customer</th>
                  <th>Car</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="transactionBody">
                <tr>
                  <td colspan="6" class="text-center py-6 text-gray-500">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Car Section -->
    <div id="addCarSection" class="hidden px-6 py-8">
      <div class="card max-w-2xl">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Add New Car</h3>
        </div>

        <form id="addCarForm" enctype="multipart/form-data" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
              <label class="form-label">Brand</label>
              <input type="text" name="brand" class="form-control" placeholder="Toyota" required>
            </div>

            <div class="form-group">
              <label class="form-label">Model</label>
              <input type="text" name="model" class="form-control" placeholder="Fortuner" required>
            </div>

            <div class="form-group">
              <label class="form-label">Year</label>
              <input type="number" name="year" class="form-control" placeholder="2023" required>
            </div>

            <div class="form-group">
              <label class="form-label">Daily Rate (‚Çπ)</label>
              <input type="number" step="0.01" name="daily_rate" class="form-control" placeholder="5000" required>
            </div>

            <div class="form-group md:col-span-2">
              <label class="form-label">Location</label>
              <input type="text" name="location" class="form-control" placeholder="Bangalore" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Car Images (JPG/JPEG)</label>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50" id="imageUploadArea">
              <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
              <p class="text-gray-600 font-medium">Click or drag images here</p>
              <p class="text-xs text-gray-500">JPG/JPEG files up to 5MB each</p>
              <input type="file" name="images" id="imagesInput" class="hidden" accept=".jpg,.jpeg" multiple required>
            </div>
            <div id="imagesPreview" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
          </div>

          <button type="submit" class="btn btn-primary w-full justify-center">
            <i class="fas fa-plus"></i> Add Car
          </button>
        </form>
      </div>
    </div>

    <!-- Manage Cars Section -->
    <div id="manageCarsSection" class="hidden px-6 py-8">
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Manage Cars</h3>
          <input type="text" id="carSearchInput" class="form-control w-full md:w-64" placeholder="Search cars...">
        </div>

        <div id="carsList" class="space-y-4">
          <p class="text-center text-gray-500 py-8">Loading cars...</p>
        </div>
      </div>
    </div>

    <!-- Schedule Section -->
    <div id="scheduleSection" class="hidden px-6 py-8">
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Car Schedule & Vacancies</h3>
        </div>

        <div class="space-y-4">
          <div class="form-group">
            <label class="form-label">Select Car</label>
            <select id="scheduleCarSelect" class="form-control">
              <option value="">Loading cars...</option>
            </select>
          </div>

          <button class="btn btn-primary" id="viewScheduleBtn">
            <i class="fas fa-search"></i> View Schedule
          </button>

          <div id="scheduleResult" class="mt-6"></div>
        </div>
      </div>
    </div>

    <!-- Verify Payment Section -->
    <div id="verifyPaymentSection" class="hidden px-6 py-8">
      <div class="card max-w-2xl">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Verify Payment (QR Scanner)</h3>
        </div>

        <div id="qrResult" class="mb-4"></div>

        <div class="space-y-4">
          <video id="video" class="w-full border-2 border-gray-300 rounded-lg mb-4" height="300"></video>

          <div id="scanStatus" class="text-sm text-gray-600 text-center"></div>

          <div class="flex gap-3 justify-center flex-wrap">
            <button class="btn btn-primary" id="startScanBtn">
              <i class="fas fa-camera"></i> Start Scan
            </button>
            <button class="btn btn-danger" id="stopScanBtn">
              <i class="fas fa-stop"></i> Stop Scan
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cancellations Section -->
    <div id="cancellationsSection" class="hidden px-6 py-8">
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Cancellations & Refunds</h3>
          <button class="btn btn-success" id="processAllRefundsBtn">
            <i class="fas fa-check"></i> Process All Refunds
          </button>
        </div>

        <div class="table-responsive">
          <table class="table" id="cancellationsTable">
            <thead>
              <tr>
                <th>Booking ID</th>
                <th>Customer</th>
                <th>Car</th>
                <th>Reason</th>
                <th>Cancelled At</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="cancellationsBody">
              <tr>
                <td colspan="6" class="text-center py-6 text-gray-500">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Business Details Section -->
    <div id="businessSection" class="hidden px-6 py-8">
      <div class="card max-w-2xl">
        <div class="card-header">
          <h3 class="text-lg font-semibold text-gray-900">Business Details</h3>
        </div>

        <div class="p-6 text-center bg-blue-50 rounded-lg">
          <i class="fas fa-info-circle text-3xl text-blue-600 mb-3"></i>
          <p class="text-gray-700 font-medium">Business settings coming soon</p>
          <p class="text-sm text-gray-500 mt-2">Add GST, company information, and legal details here</p>
        </div>
      </div>
    </div>

  </main>

  <!-- Backend Config & Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const BACKEND_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:3000'
      : 'https://a6cars-backend-ylx7.onrender.com';

    function api(path) {
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return path;
      return BACKEND_URL + path;
    }

    function getAdminToken() {
      return sessionStorage.getItem('adminToken') || '';
    }

    function setAdminToken(token) {
      sessionStorage.setItem('adminToken', token);
      sessionStorage.setItem('adminLoggedIn', '1');
      showSection('dashboard');
      loadDashboard();
    }

    function removeAdminToken() {
      sessionStorage.clear();
      location.reload();
    }

    function showToast(msg, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Sidebar Toggle
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const sidebarToggle = document.getElementById('sidebarToggle');

    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('active');
      sidebarOverlay.classList.toggle('active');
    });

    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    });

    // Section Navigation
    function showSection(sectionId) {
      const sections = ['dashboardSection', 'addCarSection', 'manageCarsSection', 'scheduleSection', 'verifyPaymentSection', 'cancellationsSection', 'businessSection'];
      sections.forEach(sec => document.getElementById(sec).classList.add('hidden'));

      if (sectionId === 'login') {
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('topLogoutBtn').classList.add('hidden');
      } else if (getAdminToken()) {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById(sectionId + 'Section').classList.remove('hidden');
        document.getElementById('topLogoutBtn').classList.remove('hidden');

        document.querySelectorAll('.sidebar-menu-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`[data-section="${sectionId}"]`)?.classList.add('active');

        const titles = { 'dashboard': 'Dashboard', 'add-car': 'Add Car', 'manage-cars': 'Manage Cars', 'schedule': 'Schedule', 'verify-payment': 'Verify Payment', 'cancellations': 'Cancellations', 'business': 'Business Details' };
        document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
      } else {
        showSection('login');
      }
    }

    // Sidebar Menu Click
    document.querySelectorAll('.sidebar-menu-item').forEach(el => {
      el.addEventListener('click', () => {
        const section = el.dataset.section;
        showSection(section);
      });
    });

    // Login Form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');

      errorDiv.classList.add('hidden');

      try {
        console.log('Attempting login with:', { email });
        const res = await fetch(api('/api/admin/login'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const text = await res.text();
        console.log('Login response status:', res.status);
        console.log('Login response text:', text);

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse response:', e);
          throw new Error('Invalid server response');
        }

        if (!res.ok) throw new Error(data.message || 'Login failed');

        console.log('Login successful, token:', data.token);
        setAdminToken(data.token);
        showToast('‚úÖ Login successful!', 'success');
      } catch (err) {
        console.error('Login error:', err);
        errorDiv.textContent = '‚ùå ' + err.message;
        errorDiv.classList.remove('hidden');
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', removeAdminToken);
    document.getElementById('topLogoutBtn').addEventListener('click', removeAdminToken);

    // Add Car Image Upload
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imagesInput = document.getElementById('imagesInput');
    const imagesPreview = document.getElementById('imagesPreview');

    imageUploadArea.addEventListener('click', () => imagesInput.click());

    imagesInput.addEventListener('change', (e) => {
      imagesPreview.innerHTML = '';
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'w-full h-24 object-cover rounded-lg';
          imagesPreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // Add Car Form Submit
    document.getElementById('addCarForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const token = getAdminToken();
      if (!token) {
        showToast('‚ùå Not authenticated. Please login again.', 'error');
        return;
      }

      const formData = new FormData(e.target);
      console.log('Adding car with form data:', {
        brand: formData.get('brand'),
        model: formData.get('model'),
        year: formData.get('year'),
        daily_rate: formData.get('daily_rate'),
        location: formData.get('location'),
        imageCount: formData.getAll('images').length
      });

      try {
        const res = await fetch(api('/api/admin/addcar'), {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData
        });

        const text = await res.text();
        console.log('Add car response:', res.status, text);

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse add car response:', e);
          throw new Error('Invalid server response');
        }

        if (!res.ok) throw new Error(data.message || 'Failed to add car');

        showToast('‚úÖ Car added successfully!', 'success');
        e.target.reset();
        imagesPreview.innerHTML = '';
        loadCarList();
      } catch (err) {
        console.error('Add car error:', err);
        showToast('‚ùå ' + err.message, 'error');
      }
    });

    // Load Dashboard
    async function loadDashboard() {
      try {
        console.log('Loading dashboard...');
        const res = await fetch(api('/api/cars'));
        const cars = await res.json();
        console.log('Cars loaded:', cars.length);
        document.getElementById('statCars').textContent = cars.length;

        const txRes = await fetch(api('/api/admin/transactions'), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });
        
        if (!txRes.ok) {
          console.warn('Transactions fetch failed:', txRes.status);
          document.getElementById('statBookings').textContent = '0';
          document.getElementById('transactionBody').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No transactions found</td></tr>';
          return;
        }

        const txData = await txRes.json();
        console.log('Transactions response:', txData);
        
        // Handle both { data: [] } and [] response formats
        const transactions = txData.data || txData;
        console.log('Transactions loaded:', transactions.length);
        document.getElementById('statBookings').textContent = transactions.length || 0;

        const tbody = document.getElementById('transactionBody');
        tbody.innerHTML = (transactions || []).slice(0, 10).map(tx => `
          <tr>
            <td>${tx.payment_id || tx.id}</td>
            <td>${tx.customer_name || 'N/A'}</td>
            <td>${tx.brand} ${tx.model}</td>
            <td>‚Çπ${(tx.payment_amount || tx.amount || 0).toLocaleString()}</td>
            <td><span class="badge ${tx.payment_status === 'completed' || tx.status === 'completed' ? 'badge-success' : 'badge-warning'}">${tx.payment_status || tx.status || 'pending'}</span></td>
            <td>${new Date(tx.start_date || Date.now()).toLocaleDateString()}</td>
          </tr>
        `).join('') || '<tr><td colspan="6" class="text-center py-4 text-gray-500">No transactions found</td></tr>';
      } catch (err) {
        console.error('Dashboard load error:', err);
        document.getElementById('statBookings').textContent = '‚Äî';
        document.getElementById('statCars').textContent = '‚Äî';
        document.getElementById('transactionBody').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading: ' + err.message + '</td></tr>';
      }
    }

    // Load Cars List
    async function loadCarList() {
      try {
        console.log('Loading cars list...');
        const res = await fetch(api('/api/cars'));
        
        if (!res.ok) {
          console.error('Cars fetch failed:', res.status);
          document.getElementById('carsList').innerHTML = '<p class="text-red-500">Failed to load cars</p>';
          return;
        }

        const cars = await res.json();
        console.log('Cars fetched:', cars);
        const carsList = document.getElementById('carsList');

        if (!cars || !Array.isArray(cars) || cars.length === 0) {
          carsList.innerHTML = '<p class="text-center text-gray-500 py-8">No cars found</p>';
          return;
        }

        carsList.innerHTML = cars.map(car => {
          const imageUrl = car.images && car.images[0] 
            ? (car.images[0].startsWith('http') ? car.images[0] : BACKEND_URL + car.images[0]) 
            : 'https://via.placeholder.com/100x80?text=No+Image';
          
          return `
            <div class="border rounded-lg p-4 flex justify-between items-start md:items-center gap-4 hover:shadow-lg">
              <div class="flex gap-4 items-start flex-1">
                <img src="${imageUrl}" class="w-24 h-20 rounded object-cover" onerror="this.src='https://via.placeholder.com/100x80'">
                <div>
                  <h4 class="font-semibold text-gray-900">${car.brand} ${car.model}</h4>
                  <p class="text-sm text-gray-600">Year: ${car.year} | ‚Çπ${car.daily_rate}/day</p>
                  <p class="text-xs text-gray-500">${car.location || 'N/A'}</p>
                </div>
              </div>
              <div class="flex gap-2 flex-col">
                <button class="btn btn-primary text-xs" onclick="viewCarBookings(${car.id}, '${car.brand} ${car.model}')">View Bookings</button>
                <button class="btn btn-danger text-xs" onclick="deleteCar(${car.id})">Delete</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Load cars error:', err);
        document.getElementById('carsList').innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
      }
    }

    // Delete Car
    async function deleteCar(id) {
      if (!confirm("Delete this car and all its bookings?")) return;

      try {
        console.log('Deleting car:', id);
        const res = await fetch(api('/api/deletecar'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAdminToken() },
          body: JSON.stringify({ car_id: id })
        });

        const text = await res.text();
        console.log('Delete response:', res.status, text);

        let data = {};
        try {
          data = JSON.parse(text);
        } catch (e) {
          console.error('Failed to parse delete response:', e);
          throw new Error('Invalid server response');
        }

        if (!res.ok) throw new Error(data.message || 'Failed to delete');

        showToast('‚úÖ Car deleted successfully!', 'success');
        loadCarList();
      } catch (err) {
        console.error('Delete car error:', err);
        showToast('‚ùå ' + err.message, 'error');
      }
    }

    // View Car Bookings
    async function viewCarBookings(carId, carName) {
      try {
        const res = await fetch(api(`/api/bookings/${carId}`), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });
        const bookings = await res.json();

        let html = `<h4 class="font-semibold mb-4">Bookings for ${carName}</h4>`;
        
        if (!bookings || bookings.length === 0) {
          html += '<p class="text-gray-500">No bookings for this car</p>';
        } else {
          html += '<div class="table-responsive"><table class="table"><thead><tr><th>Booking ID</th><th>Customer</th><th>From</th><th>To</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
          bookings.forEach(b => {
            html += `<tr><td>${b.id}</td><td>${b.customer_name || 'N/A'}</td><td>${new Date(b.start_date).toLocaleDateString()}</td><td>${new Date(b.end_date).toLocaleDateString()}</td><td>‚Çπ${b.amount || 0}</td><td><span class="badge badge-${b.status === 'confirmed' ? 'success' : 'warning'}">${b.status || 'pending'}</span></td></tr>`;
          });
          html += '</tbody></table></div>';
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `<div class="card w-full max-w-2xl">${html}<button class="btn btn-secondary mt-4 w-full" onclick="this.closest('.fixed').remove()">Close</button></div>`;
        document.body.appendChild(modal);
      } catch (err) {
        showToast('‚ùå ' + err.message, 'error');
      }
    }

    // QR Scanner Functions
    let scanning = false;
    let scannerInterval;

    document.getElementById('startScanBtn').addEventListener('click', () => {
      startScanner();
    });

    document.getElementById('stopScanBtn').addEventListener('click', () => {
      stopScanner();
    });

    async function startScanner() {
      try {
        const video = document.getElementById('video');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        scanning = true;
        document.getElementById('scanStatus').textContent = 'üé• Camera active - scanning...';

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        scannerInterval = setInterval(() => {
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);

              if (code) {
                stopScanner();
                processQRCode(code.data);
              }
            } catch (err) {
              console.log('QR scan error:', err);
            }
          }
        }, 100);
      } catch (err) {
        showToast('‚ùå Camera access denied: ' + err.message, 'error');
        document.getElementById('scanStatus').textContent = '‚ùå Camera not available';
      }
    }

    function stopScanner() {
      scanning = false;
      const video = document.getElementById('video');
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      clearInterval(scannerInterval);
      document.getElementById('scanStatus').textContent = 'Scanner stopped';
    }

    async function processQRCode(qrData) {
      try {
        // Parse QR data if it's JSON
        let parsedData = qrData;
        try {
          parsedData = JSON.parse(qrData);
        } catch (e) {
          // If not JSON, treat as booking_id
          parsedData = { booking_id: qrData, qr_type: 'collection' };
        }

        const res = await fetch(api('/api/admin/verify-qr'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAdminToken() },
          body: JSON.stringify({ qr_data: parsedData })
        });

        const result = await res.json();
        const resultDiv = document.getElementById('qrResult');

        if (res.ok) {
          resultDiv.innerHTML = `<div class="p-4 bg-green-50 border border-green-200 rounded-lg"><h4 class="font-semibold text-green-800">‚úÖ Verified</h4><p class="text-sm text-green-700 mt-2">${result.message || 'Verification successful'}</p></div>`;
          showToast('‚úÖ Payment verified!', 'success');
        } else {
          resultDiv.innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="font-semibold text-red-800">‚ùå Verification Failed</h4><p class="text-sm text-red-700 mt-2">${result.message || 'Failed to verify'}</p></div>`;
          showToast('‚ùå ' + result.message, 'error');
        }
      } catch (err) {
        console.error('QR processing error:', err);
        showToast('‚ùå Error: ' + err.message, 'error');
        document.getElementById('qrResult').innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg"><p class="text-sm text-red-700">Error: ${err.message}</p></div>`;
      }
    }

    // Load Schedule
    document.getElementById('viewScheduleBtn').addEventListener('click', async () => {
      const carId = document.getElementById('scheduleCarSelect').value;
      if (!carId) {
        showToast('Please select a car', 'error');
        return;
      }

      try {
        const res = await fetch(api(`/api/admin/car-schedule/${carId}`), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });

        const data = await res.json();
        const resultDiv = document.getElementById('scheduleResult');

        let html = '<h4 class="font-semibold mb-4">Car Schedule</h4>';

        if (data.bookings && data.bookings.length > 0) {
          html += '<div class="table-responsive"><table class="table"><thead><tr><th>Booking ID</th><th>From</th><th>To</th><th>Status</th></tr></thead><tbody>';
          data.bookings.forEach(b => {
            html += `<tr><td>${b.id}</td><td>${new Date(b.start_date).toLocaleDateString()}</td><td>${new Date(b.end_date).toLocaleDateString()}</td><td><span class="badge badge-${b.status === 'confirmed' ? 'success' : 'warning'}">${b.status}</span></td></tr>`;
          });
          html += '</tbody></table></div>';
        } else {
          html += '<p class="text-gray-500">No bookings scheduled</p>';
        }

        if (data.vacancies && data.vacancies.length > 0) {
          html += '<div class="mt-6"><h5 class="font-semibold mb-3">Available Dates (Next 180 Days)</h5>';
          data.vacancies.forEach(v => {
            html += `<div class="p-2 bg-green-50 border border-green-200 rounded text-sm mb-2">${v.start} ‚Üí ${v.end}</div>`;
          });
          html += '</div>';
        }

        resultDiv.innerHTML = html;
      } catch (err) {
        showToast('‚ùå ' + err.message, 'error');
      }
    });

    // Load schedule options on page load
    async function loadScheduleOptions() {
      try {
        const res = await fetch(api('/api/cars'));
        const cars = await res.json();
        const select = document.getElementById('scheduleCarSelect');
        select.innerHTML = '<option value="">Select a car...</option>';
        cars.forEach(car => {
          const option = document.createElement('option');
          option.value = car.id;
          option.textContent = `${car.brand} ${car.model} - ${car.location}`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Load schedule options error:', err);
      }
    }

    // Load cancellations
    async function loadCancellations() {
      try {
        const res = await fetch(api('/api/admin/canceled-bookings'), {
          headers: { 'Authorization': 'Bearer ' + getAdminToken() }
        });

        const cancellations = await res.json();
        const tbody = document.getElementById('cancellationsBody');

        if (!cancellations || cancellations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No cancellations</td></tr>';
          return;
        }

        tbody.innerHTML = cancellations.map(c => `
          <tr>
            <td>${c.booking_id}</td>
            <td>${c.customer_name || 'N/A'}</td>
            <td>${c.brand} ${c.model}</td>
            <td>${c.reason || 'N/A'}</td>
            <td>${new Date(c.cancelled_at).toLocaleDateString()}</td>
            <td><span class="badge badge-warning">${c.status || 'pending'}</span></td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Load cancellations error:', err);
      }
    }

    document.getElementById('processAllRefundsBtn').addEventListener('click', async () => {
      if (!confirm('Process all pending refunds?')) return;

      try {
        const res = await fetch(api('/api/admin/process-refunds'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getAdminToken() }
        });

        const result = await res.json();
        if (res.ok) {
          showToast('‚úÖ ' + result.message, 'success');
          loadCancellations();
        } else {
          showToast('‚ùå ' + result.message, 'error');
        }
      } catch (err) {
        showToast('‚ùå ' + err.message, 'error');
      }
    });

    // Initialize
    if (getAdminToken()) {
      showSection('dashboard');
      loadDashboard();
      loadCarList();
      loadScheduleOptions();
      loadCancellations();
    } else {
      showSection('login');
    }
  </script>

  <!-- ========================= MAIN BODY LAYOUT ========================= -->
  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- Login card -->
    <div id="admin-login"
         class="max-w-md mx-auto bg-white rounded-lg shadow p-6 space-y-4">
      <h1 class="text-xl font-semibold text-center mb-2">Admin Login</h1>

      <input id="admin-email" type="text" placeholder="Admin Email"
             class="w-full p-3 border rounded" />

      <input id="admin-password" type="password" placeholder="Password"
             class="w-full p-3 border rounded" />

      <button id="admin-login-btn"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">
        Login
      </button>

      <div id="admin-login-msg"
           class="text-sm text-red-600 text-center"></div>
    </div>

    <!-- ========================= DASHBOARD ========================= -->
    <div id="admin-dashboard" class="hidden">

      <div class="flex flex-col lg:flex-row gap-6">

        <!-- üåô Modern Sidebar -->
        <aside class="w-full lg:w-72">
          <div class="bg-white rounded-lg shadow p-4 lg:sticky lg:top-28">

            <!-- Profile header -->
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 rounded-xl bg-blue-600 text-white flex items-center justify-center text-lg font-semibold">
                A6
              </div>
              <div>
                <div class="font-semibold text-gray-900 text-sm">A6 Admin</div>
                <div class="text-xs text-gray-500">Control Panel</div>
              </div>
            </div>

            <!-- üåê New Modern Sidebar Menu -->
            <div class="space-y-1 mb-6">

              <button class="side-link" data-section="section-addcar">
                üöó <span>Add Cars</span>
              </button>

              <button class="side-link" data-section="section-managecar">
                üõ† <span>Manage Cars</span>
              </button>

              <button class="side-link" data-section="section-verify">
                üì∑ <span>Verify Payment</span>
              </button>

              <button class="side-link" data-section="section-business">
                üè¢ <span>Business Details</span>
              </button>

              <button class="side-link" data-section="all">
                üìã <span>Show All</span>
              </button>

              <button class="side-link" data-section="section-cancellations">
                ‚ùå <span>Cancellations</span>
              </button>

              <button class="side-link" data-section="section-schedule">
                üìÖ <span>Car Schedule</span>
              </button>

            </div>

            <!-- Filters for Recent Transactions -->
            <div class="border-t pt-4 mt-4">
              <div class="text-sm font-semibold mb-2">Filters</div>

              <div class="space-y-2">
                <input id="filter-search" type="text" placeholder="Search"
                       class="w-full border rounded px-2 py-2 text-sm" />

                <div class="flex gap-2">
                  <input id="filter-from" type="date"
                         class="w-1/2 border rounded px-2 py-2 text-xs" />
                  <input id="filter-to" type="date"
                         class="w-1/2 border rounded px-2 py-2 text-xs" />
                </div>

                <div class="flex gap-2">
                  <button id="filter-apply"
                          class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm">
                    Apply
                  </button>

                  <button id="filter-clear"
                          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded text-sm">
                    Clear
                  </button>
                </div>
              </div>
            </div>

            <!-- Logout inside sidebar -->
            <button id="sidebar-logout"
              class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm font-medium">
              Logout
            </button>

          </div>
        </aside>

        <!-- ========================= MAIN CONTENT ========================= -->
        <section class="flex-1 space-y-6" id="admin-main">

          <!-- Dashboard quick stats -->
          <div class="bg-white rounded-lg shadow p-6">
            <h1 class="text-2xl font-bold mb-1">Admin Panel</h1>
            <p class="text-sm text-gray-500 mb-4">
              Manage cars, bookings and verify payments
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

              <div class="p-4 rounded shadow-sm bg-blue-50">
                <div class="text-sm text-gray-500">Total Bookings</div>
                <div id="stat-bookings" class="text-2xl font-bold">‚Äî</div>
              </div>

              <div class="p-4 rounded shadow-sm bg-yellow-50">
                <div class="text-sm text-gray-500">Pending Payments</div>
                <div id="stat-pending" class="text-2xl font-bold">‚Äî</div>
              </div>

              <div class="p-4 rounded shadow-sm bg-green-50">
                <div class="text-sm text-gray-500">Available Cars</div>
                <div id="stat-cars" class="text-2xl font-bold">‚Äî</div>
              </div>

            </div>
          </div><!-- ========================= ADD CAR SECTION ========================= -->
<section id="section-addcar" class="hidden">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-lg font-semibold mb-3">Add Car (Multiple Images)</h3>

    <form id="addCarForm" enctype="multipart/form-data" class="space-y-3">

      <input type="text" name="brand" placeholder="Brand" required
             class="w-full p-2 border rounded" />

      <input type="text" name="model" placeholder="Model" required
             class="w-full p-2 border rounded" />

      <input type="number" name="year" placeholder="Year" required
             class="w-full p-2 border rounded" />

      <input type="number" step="0.01" name="daily_rate"
             placeholder="Daily Rate (INR)" required
             class="w-full p-2 border rounded" />

      <input type="text" name="location" placeholder="Location" required
             class="w-full p-2 border rounded" />

      <label class="text-sm text-gray-600">Upload Images (JPG/JPEG)</label>
      <input type="file" name="images" id="images-input"
             accept=".jpg,.jpeg" multiple required
             class="w-full p-2 border rounded bg-gray-50" />

      <div id="images-preview"
           class="flex gap-2 mt-2 flex-wrap"></div>

      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white w-full p-2 rounded">
        Add Car
      </button>
    </form>
  </div>
</section>



<!-- ========================= MANAGE CARS SECTION ========================= -->
<section id="section-managecar" class="hidden">
  <div class="bg-white p-4 rounded shadow">

    <h3 class="text-lg font-semibold mb-3">Manage Cars</h3>

    <div id="car-list" class="space-y-3"></div>

    <!-- Bookings panel below each car -->
    <div id="car-bookings-panel"
         class="hidden mt-4 bg-gray-50 p-3 rounded">

      <div class="flex items-center justify-between mb-2">
        <h4 class="font-medium">
          Bookings for <span id="car-bookings-title"></span>
        </h4>

        <button id="close-car-bookings"
                class="text-xs bg-gray-200 px-2 py-1 rounded">
          Close
        </button>
      </div>

      <div class="overflow-auto">
        <table class="w-full text-left border-collapse text-xs">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">Booking ID</th>
              <th class="border px-2 py-1">Customer</th>
              <th class="border px-2 py-1">From</th>
              <th class="border px-2 py-1">To</th>
              <th class="border px-2 py-1">Amount</th>
              <th class="border px-2 py-1">Paid</th>
              <th class="border px-2 py-1">Verified</th>
            </tr>
          </thead>
          <tbody id="car-bookings-body"></tbody>
        </table>
      </div>

    </div>

  </div>
</section>


<!-- ========================= CANCELLATIONS SECTION ========================= -->
<section id="section-cancellations" class="hidden">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-lg font-semibold mb-3">Cancellations</h3>
    <div class="flex items-center gap-2 mb-3">
      <button id="process-refunds-all" class="bg-green-600 text-white px-3 py-1 rounded">Process Pending Refunds</button>
      <input id="process-refund-id" type="number" placeholder="Refund ID (optional)" class="border px-2 py-1 rounded text-sm" />
      <button id="process-refund-single" class="bg-blue-600 text-white px-3 py-1 rounded">Process Refund ID</button>
    </div>
    <div id="cancellations-list" class="text-sm text-gray-700">Loading...</div>
  </div>
</section>


<!-- ========================= CAR SCHEDULE SECTION ========================= -->
<section id="section-schedule" class="hidden">
  <div class="bg-white p-4 rounded shadow">
    <h3 class="text-lg font-semibold mb-3">Car Schedule & Vacancies</h3>
    <div class="flex gap-2 mb-3">
      <select id="schedule-car-select" class="border p-2 rounded"></select>
      <button id="schedule-view" class="bg-blue-600 text-white px-3 py-1 rounded">View Schedule</button>
    </div>
    <div id="schedule-result" class="text-sm text-gray-700"></div>
  </div>
</section>


<!-- ========================= VERIFY PAYMENT SECTION ========================= -->
<section id="section-verify" class="hidden">
  <div class="bg-white rounded-lg shadow p-4" id="col-verify">

    <h3 class="text-lg font-semibold mb-3">Verify Payment (Scan QR)</h3>

    <div id="qr-result" class="mt-2 text-sm"></div>

    <div id="scanner" class="mt-4">
      <h4 class="font-medium mb-2 text-sm">Camera Scanner</h4>

      <video id="video" width="100%" height="220"
             class="border rounded"></video>

      <div id="scan-status"
           class="text-xs mt-2 text-gray-600"></div>

      <div class="mt-2 flex gap-2">

        <button id="start-scan"
                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
          Start Scan
        </button>

        <button id="stop-scan"
                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
          Stop Scan
        </button>

      </div>
    </div>

  </div>
</section>



<!-- ========================= BUSINESS DETAILS SECTION ========================= -->
<section id="section-business" class="hidden">
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="text-lg font-semibold mb-3">Business Details</h3>

    <p class="text-sm text-gray-600">
      Add GST, company information, legal details and settings here later.
    </p>
  </div>
</section><!-- ========================= RECENT TRANSACTIONS SECTION ========================= -->
<section id="section-transactions">
  <div class="bg-white rounded-lg shadow p-4">

    <h3 class="text-lg font-semibold mb-3">Recent Transactions</h3>
    <p class="text-xs text-gray-500 mb-2">
      Showing up to 10 most recent bookings/payments.
    </p>

    <div class="overflow-auto">
      <table id="tx-table" class="w-full text-left text-sm border-collapse">

        <thead class="bg-gray-50">
          <tr>
            <th class="border px-2 py-1">Payment ID</th>
            <th class="border px-2 py-1">Customer</th>
            <th class="border px-2 py-1">Car</th>
            <th class="border px-2 py-1">From</th>
            <th class="border px-2 py-1">To</th>
            <th class="border px-2 py-1">Amount</th>
            <th class="border px-2 py-1">Paid</th>
            <th class="border px-2 py-1">Verified</th>
          </tr>
        </thead>

        <tbody id="tx-body">
          <!-- JS renders latest 10 transactions -->
        </tbody>

      </table>
    </div>

  </div>
</section>



<!-- ========================= LIGHTBOX ‚Äî IMG VIEWER ========================= -->
<div id="lightbox"
     class="fixed inset-0 hidden items-center justify-center z-50">

  <div id="lb-backdrop"
       class="absolute inset-0 lb-backdrop"></div>

  <div class="relative z-50 max-w-3xl w-full mx-4">

    <div class="bg-white rounded p-4 shadow-xl">

      <div class="flex justify-between items-center mb-2">
        <div id="lb-title" class="font-semibold">Images</div>

        <button id="lb-close"
                class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
          Close
        </button>
      </div>

      <div id="lb-images"
           class="flex gap-2 overflow-x-auto"></div>

    </div>

  </div>
</div><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
/* ============================================================
   AUTH HELPERS
============================================================ */
function getAdminToken() {
  return sessionStorage.getItem('adminToken') || '';
}

function setAdminToken(token) {
  sessionStorage.setItem('adminToken', token);
  sessionStorage.setItem('adminLoggedIn', '1');

  document.getElementById('admin-login').classList.add('hidden');
  document.getElementById('admin-dashboard').classList.remove('hidden');
  document.getElementById('admin-logout').classList.remove('hidden');

    loadCarList();
    loadTransactions();
    ensureAdminExtras();
}

function doLogout() {
  sessionStorage.clear();
  stopScan();

  document.getElementById('admin-dashboard').classList.add('hidden');
  document.getElementById('admin-login').classList.remove('hidden');
  document.getElementById('admin-logout').classList.add('hidden');
}


/* ============================================================
   ADMIN LOGIN
============================================================ */
document.getElementById('admin-login-btn').addEventListener('click', async () => {
  const email = document.getElementById('admin-email').value.trim();
  const password = document.getElementById('admin-password').value;
  const msg = document.getElementById('admin-login-msg');

  msg.innerText = '';

  try {
    const res = await fetch(api('/api/admin/login'), {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, password })
    });

    const txt = await res.text();
    let j = {};
    try { j = JSON.parse(txt); } catch {}

    if (!res.ok) throw new Error(j.message || 'Login failed');

    setAdminToken(j.token);
  }
  catch(err) {
    msg.innerText = err.message;
  }
});

document.getElementById('admin-logout').addEventListener('click', doLogout);
document.getElementById('sidebar-logout').addEventListener('click', doLogout);


/* ============================================================
   SIDEBAR SECTION SWITCHER + ACTIVE BUTTON
============================================================ */
const sectionIds = [
  'section-addcar',
  'section-managecar',
  'section-verify',
  'section-business',
  'section-cancellations',
  'section-schedule'
];

document.querySelectorAll('.side-link').forEach(btn => {
  btn.addEventListener('click', () => {
    const section = btn.dataset.section;

    // active highlight
    document.querySelectorAll('.side-link').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    showSection(section);
  });
});

// Start / Stop scan button bindings
const _startScanBtn = document.getElementById('start-scan');
const _stopScanBtn = document.getElementById('stop-scan');
if (_startScanBtn) _startScanBtn.addEventListener('click', (e) => { e.preventDefault(); startScan(); });
if (_stopScanBtn) _stopScanBtn.addEventListener('click', (e) => { e.preventDefault(); stopScan(); });

function showSection(which) {
  if (which === 'all') {
    sectionIds.forEach(id => document.getElementById(id).classList.remove('hidden'));
  } else {
    sectionIds.forEach(id => {
      document.getElementById(id).classList.toggle('hidden', id !== which);
    });
  }

  if (which === 'section-verify' || which === 'all') startScan();

  document.getElementById('admin-main')
    .scrollIntoView({ behavior:'smooth', block:'start' });
}


/* ============================================================
   ADD CAR ‚Äî MULTIPLE IMAGES
============================================================ */
const imagesInput = document.getElementById('images-input');
const imagesPreview = document.getElementById('images-preview');

imagesInput.addEventListener('change', function() {
  imagesPreview.innerHTML = '';
  Array.from(this.files).forEach(file => {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    img.className = 'w-28 h-20 object-cover rounded border';
    imagesPreview.appendChild(img);
  });
});

document.getElementById('addCarForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const token = getAdminToken();
  if (!token) return alert("Please login as admin");

  const fd = new FormData(this);

  try {
    const res = await fetch(api('/api/admin/addcar'), {
      method: 'POST',
      headers: { 'Authorization':'Bearer '+token },
      body: fd
    });

    const txt = await res.text();
    let j = {};
    try { j = JSON.parse(txt);} catch {}

    if (!res.ok) throw new Error(j.message);

    alert("Car added successfully!");

    this.reset();
    imagesPreview.innerHTML = '';
    loadCarList();
  }
  catch(err) {
    alert(err.message);
  }
});


/* ============================================================
   LOAD ALL CARS + DELETE + VIEW BOOKINGS
============================================================ */
async function loadCarList() {
  try {
    const token = getAdminToken();
    const headers = token ? {Authorization:'Bearer '+token} : {};

    const res = await fetch(api('/api/cars'), { headers });
    const list = await res.json();

    const carList = document.getElementById('car-list');
    carList.innerHTML = '';

    if (!list.length) {
      carList.innerHTML = `<div class="text-gray-500 text-sm">No cars found.</div>`;
      document.getElementById('stat-cars').innerText = '0';
      return;
    }

    document.getElementById('stat-cars').innerText = list.length;

    list.forEach(car => {
      const imgs = (car.images || []).map(u =>
        u.startsWith('http') ? u : BACKEND_URL + '/' + u
      );

      const thumb = imgs[0] || 'https://via.placeholder.com/160x100?text=No+Image';

      const div = document.createElement('div');
      div.className = "border rounded p-3 bg-white flex justify-between items-center";

      div.innerHTML = `
        <div class="flex gap-4 items-center">
          <img src="${thumb}" class="w-32 h-20 rounded border cursor-pointer"
               data-images='${JSON.stringify(imgs)}'>

          <div class="text-sm">
            <div class="font-semibold">${car.brand} ${car.model}</div>
            <div class="text-xs text-gray-600">Year: ${car.year} | ‚Çπ${car.daily_rate}/day</div>
            <div class="text-xs text-gray-400">${car.location || ''}</div>
          </div>
        </div>

        <div class="flex flex-col gap-1 text-xs">
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded view-bookings"
                  data-carid="${car.id}" data-carname="${car.brand} ${car.model}">
            View Bookings
          </button>
          <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded delete-car"
                  data-carid="${car.id}">
            Delete
          </button>
        </div>
      `;

      carList.appendChild(div);

      div.querySelector('img').addEventListener('click', () => {
        openLightbox(imgs, `${car.brand} ${car.model}`);
      });

      div.querySelector('.view-bookings').addEventListener('click', () => {
        viewCarBookings(car.id, `${car.brand} ${car.model}`);
      });

      div.querySelector('.delete-car').addEventListener('click', () => deleteCar(car.id));
    });

  } catch(err) {
    console.error(err);
  }
}

async function deleteCar(id) {
  if (!confirm("Delete this car and its bookings?")) return;

  const token = getAdminToken();
 const headers = {
    'Content-Type':'application/json',
    'Authorization':'Bearer '+token
  };

  const res = await fetch(api('/api/deletecar'), {
    method:'POST',
    headers,
    body: JSON.stringify({ car_id:id })
  });

  const j = await res.json();
  alert(j.message || "Deleted");
  loadCarList();
}


/* ============================================================
   VIEW BOOKINGS PER CAR (FULLY FIXED)
============================================================ */
function viewCarBookings(carId, carName) {
  const panel = document.getElementById('car-bookings-panel');
  const title = document.getElementById('car-bookings-title');
  const body = document.getElementById('car-bookings-body');

  title.textContent = carName;
  panel.classList.remove('hidden');

  body.innerHTML = `<tr><td colspan="8" class="text-gray-500 text-xs p-2">Loading...</td></tr>`;

  const token = getAdminToken();

  fetch(api(`/api/bookings/${carId}`), {
    headers: token ? { Authorization:'Bearer '+token } : {}
  })
  .then(r => r.json())
  .then(list => {
    body.innerHTML = '';

    if (!list.length) {
      body.innerHTML = `<tr><td colspan="8" class="text-gray-500 text-xs p-2">No bookings found.</td></tr>`;
      return;
    }

    list.forEach(bk => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="border px-2 py-1">${bk.booking_id ?? bk.id ?? '‚Äî'}</td>
        <td class="border px-2 py-1">${bk.customer_name || bk.name || bk.email || ''}</td>
        <td class="border px-2 py-1">${new Date(bk.start_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">${new Date(bk.end_date).toLocaleDateString()}</td>
        <td class="border px-2 py-1">${bk.amount ? '‚Çπ'+bk.amount : '-'}</td>

        <td class="border px-2 py-1">
          ${(bk.paid==1 || bk.is_paid==1 || bk.payment_status==1) ? 'Yes' : 'No'}
        </td>

        <td class="border px-2 py-1">
          ${(bk.verified==1 || bk.is_verified==1 || bk.verification_status==1) ? 'Yes' : 'No'}
        </td>
      `;

      // Action cell
      const actionTd = document.createElement('td');
      actionTd.className = 'border px-2 py-1';
      if (bk.status === 'cancelled') {
        actionTd.innerHTML = '<span class="text-red-600 font-semibold">Cancelled</span>';
      } else {
        const btn = document.createElement('button');
        btn.className = 'bg-red-500 text-white px-2 py-1 rounded admin-cancel';
        btn.dataset.booking = bk.id;
        btn.innerText = 'Cancel';
        actionTd.appendChild(btn);
      }

      body.appendChild(tr);
      tr.appendChild(actionTd);
    });

    // attach listeners for cancel buttons
    body.querySelectorAll('.admin-cancel').forEach(btn => {
      btn.addEventListener('click', async () => {
        const bookingId = btn.dataset.booking;
        const reason = prompt('Enter reason for cancellation:');
        if (!reason) return alert('Cancellation reason required');

        try {
          const res = await fetch(api('/api/admin/cancel-booking'), {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+getAdminToken() },
            body: JSON.stringify({ booking_id: bookingId, reason })
          });
          const j = await res.json();
          if (!res.ok) throw new Error(j.message || 'Cancel failed');
          alert(j.message);
          viewCarBookings(carId, carName);
          loadCancellations();
        } catch (err) {
          alert('Error cancelling booking: ' + err.message);
        }
      });
    });
  });
}

document.getElementById('close-car-bookings')
  .addEventListener('click', () => {
    document.getElementById('car-bookings-panel').classList.add('hidden');
  });


/* ============================================================
   RECENT TRANSACTIONS (ONLY LATEST 10)
============================================================ */
let allTransactions = [];

async function loadTransactions() {
  try {
    const res = await fetch(api('/api/admin/transactions?page=1&pageSize=50'), {
      headers: {Authorization:'Bearer '+getAdminToken()}
    });

    const data = await res.json();
    allTransactions = data.data || [];

    renderTransactions();

    // Stats
    // Total bookings shown
    document.getElementById('stat-bookings').innerText = allTransactions.length;

    // Pending = those not marked paid. Accept both boolean true and numeric 1 as paid markers.
    document.getElementById('stat-pending').innerText =
      allTransactions.filter(tx => !(tx.paid === true || tx.paid == 1)).length;
  }
  catch(err) { console.log(err); }
}

function renderTransactions() {
  const body = document.getElementById('tx-body');
  body.innerHTML = '';

  // Sort by latest
  allTransactions.sort((a,b) =>
    new Date(b.start_date) - new Date(a.start_date)
  );

  const latest10 = allTransactions.slice(0,10);

  latest10.forEach(tx => {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td class="border px-2 py-1">${tx.payment_id ?? tx.id ?? '-'}</td>
      <td class="border px-2 py-1">${tx.customer_name || tx.name || 'Unknown'}</td>
      <td class="border px-2 py-1">${tx.brand || ''} ${tx.model || ''}</td>
      <td class="border px-2 py-1">${tx.start_date ? new Date(tx.start_date).toLocaleDateString() : '-'}</td>
      <td class="border px-2 py-1">${tx.end_date ? new Date(tx.end_date).toLocaleDateString() : '-'}</td>
      <td class="border px-2 py-1">‚Çπ${tx.amount || 0}</td>
      <td class="border px-2 py-1">${(tx.paid==true || tx.paid==1) ? 'Yes' : 'No'}</td>
      <td class="border px-2 py-1">${(tx.verified==true || tx.verified==1) ? 'Yes' : 'No'}</td>
    `;

    body.appendChild(tr);
  });
}


/* ============================================================
   LIGHTBOX IMAGE VIEWER
============================================================ */
function openLightbox(images, title) {
  const lb = document.getElementById('lightbox');
  const lbImgs = document.getElementById('lb-images');
  const lbTitle = document.getElementById('lb-title');

  lbImgs.innerHTML = '';
  lbTitle.textContent = title;

  images.forEach(url => {
    const img = document.createElement('img');
    img.src = url;
    img.className = 'max-h-96 object-contain mr-2';
    lbImgs.appendChild(img);
  });

  lb.classList.remove('hidden');
  lb.classList.add('flex');
}

document.getElementById('lb-close').addEventListener('click', () => {
  document.getElementById('lightbox').classList.add('hidden');
  document.getElementById('lightbox').classList.remove('flex');
});


/* ============================================================
   QR SCANNER + VERIFY PAYMENT
============================================================ */
let videoStream = null;

async function startScan() {
  const video = document.getElementById('video');
  if (!video) return;

  const status = document.getElementById('scan-status');
  status.innerText = "Starting camera...";

  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
    video.srcObject = videoStream;
    video.play();

    status.innerText = "Scanning...";

    // BarcodeDetector first
    if (window.BarcodeDetector) {
      try {
        const detector = new BarcodeDetector({formats:['qr_code']});
        const loop = async () => {
          const codes = await detector.detect(video).catch(()=>[]);
          if (codes.length) {
            stopScan();
            verifyQrToken(codes[0].rawValue);
            return;
          }
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
        return;
      } catch {}
    }

    // jsQR fallback
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const scanLoop = () => {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video,0,0);

        const img = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(img.data,img.width,img.height);

        if (code && code.data) {
          stopScan();
          verifyQrToken(code.data);
          return;
        }
      }
      requestAnimationFrame(scanLoop);
    };

    requestAnimationFrame(scanLoop);
  }
  catch(err) {
    status.innerText = "Camera failed or permission blocked.";
  }
}

function stopScan() {
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
  const video = document.getElementById('video');
  if (video) video.srcObject = null;
}

async function verifyQrToken(token) {
  const status = document.getElementById('scan-status');

  const t = getAdminToken();
  if (!t) return status.innerText = "Admin not logged in";

  let qr_data = {};
  try { qr_data = JSON.parse(token); }
  catch { qr_data = { booking_id: token }; }

  try {
    const res = await fetch(api('/api/admin/verify-qr'), {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+t
      },
      body: JSON.stringify({qr_data})
    });

    const j = await res.json();

    if (!res.ok) throw new Error(j.message || 'Verification failed');

    playSuccessSound();
    showToast("Booking Verified!", "green");

    // The backend returns { message, qr_verification: { booking_id, customer, booking, car, ... } }
    const v = j.qr_verification || {};
    const bookingId = v.booking_id || v.booking?.booking_id || v.booking?.id || '-';
    const customerName = v.customer?.name || v.customer?.customer_name || '-';
    const carLabel = v.car?.model || v.car || (v.booking ? `${v.booking.brand || ''} ${v.booking.model || ''}` : '-');
    const amount = v.booking?.amount ?? v.amount ?? '-';

    document.getElementById('qr-result').innerHTML = `
      <div class="bg-green-50 border border-green-300 p-3 rounded mt-2 text-sm">
        <p><b>Booking ID:</b> ${bookingId}</p>
        <p><b>Customer:</b> ${customerName}</p>
        <p><b>Car:</b> ${carLabel}</p>
        <p><b>Amount:</b> ‚Çπ${amount}</p>
      </div>
    `;
    // Show vacancies when returned by server (early-return case)
    if (v.vacancies && v.vacancies.length) {
      const vacHtml = `<div class="mt-3 p-3 bg-yellow-50 rounded text-sm"><h4 class="font-semibold">Available ranges (now ‚Üí booking end)</h4>` + v.vacancies.map(r => `<div>${r.start} ‚Üí ${r.end}</div>`).join('') + `</div>`;
      document.getElementById('qr-result').innerHTML += vacHtml;
    }

    loadCarList();
    loadTransactions();
  }
  catch(err) {
    showToast(err.message, "red");
    status.innerText = "Verification failed";
  }
}


/* ============================================================
   UTILITIES
============================================================ */
function showToast(msg, color) {
  const div = document.createElement("div");

  div.style.position = "fixed";
  div.style.top = "16px";
  div.style.right = "16px";
  div.style.padding = "10px 14px";
  div.style.borderRadius = "6px";
  div.style.zIndex = "99999";
  div.style.color = "white";

  div.style.background =
    color === "green" ? "#16a34a" :
    color === "red"   ? "#dc2626" : "#4b5563";

  div.innerText = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3000);
}

function playSuccessSound() {
  new Audio("https://cdn.pixabay.com/download/audio/2022/03/15/audio_2bda1e560f.mp3").play().catch(()=>{});
}


/* ============================================================
   CANCELLATIONS & SCHEDULE HELPERS
============================================================ */

// Load cancellations list into the Cancellations section
async function loadCancellations() {
  try {
    const token = getAdminToken();
    if (!token) return;
    const res = await fetch(api('/api/admin/canceled-bookings'), { headers: { Authorization: 'Bearer ' + token } });
    const list = await res.json();
    const container = document.getElementById('cancellations-list');
    if (!container) return;

    if (!list.length) {
      container.innerHTML = `<p class="text-sm text-gray-500">No cancellations yet.</p>`;
      return;
    }

    let html = `<div class="overflow-auto"><table class="w-full text-left text-sm border-collapse"><thead class="bg-gray-50"><tr><th class="border px-2 py-1">Booking</th><th class="border px-2 py-1">Customer</th><th class="border px-2 py-1">Car</th><th class="border px-2 py-1">From</th><th class="border px-2 py-1">To</th><th class="border px-2 py-1">Reason</th><th class="border px-2 py-1">Cancelled At</th></tr></thead><tbody>`;
    list.forEach(r => {
      html += `<tr><td class="border px-2 py-1">${r.booking_id}</td><td class="border px-2 py-1">${r.customer_name}</td><td class="border px-2 py-1">${r.brand} ${r.model}</td><td class="border px-2 py-1">${new Date(r.start_date).toLocaleDateString()}</td><td class="border px-2 py-1">${new Date(r.end_date).toLocaleDateString()}</td><td class="border px-2 py-1">${r.reason}</td><td class="border px-2 py-1">${new Date(r.cancelled_at).toLocaleString()}</td></tr>`;
    });
    html += `</tbody></table></div>`;
    container.innerHTML = html;
  } catch (err) {
    console.error('Load cancellations error:', err);
  }
}

// Load car options for schedule view
async function loadScheduleOptions() {
  try {
    const res = await fetch(api('/api/cars'));
    const cars = await res.json();
    const sel = document.getElementById('schedule-car-select');
    if (!sel) return;
    sel.innerHTML = '';
    cars.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.text = `${c.brand} ${c.model} (${c.location || ''})`;
      sel.appendChild(opt);
    });
  } catch (err) { console.error('Load schedule options error:', err); }
}

document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'schedule-view') {
    const sel = document.getElementById('schedule-car-select');
    if (sel && sel.value) showCarSchedule(sel.value);
  }
});

// Render car schedule and vacancies
async function showCarSchedule(carId) {
  try {
    const token = getAdminToken();
    const res = await fetch(api(`/api/admin/car-schedule/${carId}`), { headers: { Authorization: 'Bearer ' + token } });
    if (!res.ok) throw new Error('Failed to load schedule');
    const data = await res.json();

    const out = document.getElementById('schedule-result');
    out.innerHTML = '';

    const bookings = data.bookings || [];
    if (!bookings.length) {
      out.innerHTML = `<p class="text-sm text-gray-500">No bookings for this car.</p>`;
    } else {
      const tbl = document.createElement('div');
      tbl.innerHTML = `<div class="overflow-auto"><table class="w-full text-left text-sm border-collapse"><thead class="bg-gray-50"><tr><th class="border px-2 py-1">Booking ID</th><th class="border px-2 py-1">From</th><th class="border px-2 py-1">To</th><th class="border px-2 py-1">Status</th></tr></thead><tbody>${bookings.map(b=>`<tr><td class="border px-2 py-1">${b.id}</td><td class="border px-2 py-1">${new Date(b.start_date).toLocaleDateString()}</td><td class="border px-2 py-1">${new Date(b.end_date).toLocaleDateString()}</td><td class="border px-2 py-1">${b.status}</td></tr>`).join('')}</tbody></table></div>`;
      out.appendChild(tbl);
    }

    // vacancies
    const vac = data.vacancies || [];
    if (vac.length) {
      const vdiv = document.createElement('div');
      vdiv.className = 'mt-3 p-3 bg-gray-50 rounded';
      vdiv.innerHTML = `<h4 class="font-semibold">Vacancies (next 180 days)</h4>` + vac.map(v => `<div class="text-sm">${v.start} ‚Üí ${v.end}</div>`).join('');
      out.appendChild(vdiv);
    } else {
      const vdiv = document.createElement('div');
      vdiv.className = 'mt-3 text-sm text-gray-500';
      vdiv.innerText = 'No vacancy ranges (car fully free or fully booked in window).';
      out.appendChild(vdiv);
    }
  } catch (err) {
    console.error('showCarSchedule error:', err);
    document.getElementById('schedule-result').innerHTML = `<p class="text-red-600">${err.message}</p>`;
  }
}

// When admin dashboard becomes visible, load cancellations and schedule options
function ensureAdminExtras() {
  loadCancellations();
  loadScheduleOptions();
}

// Handle refund processing actions
document.addEventListener('click', async (e) => {
  if (e.target && e.target.id === 'process-refunds-all') {
    if (!confirm('Process all pending refunds? This will mark them as processed (simulated).')) return;
    try {
      const res = await fetch(api('/api/admin/process-refunds'), {
        method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+getAdminToken() }
      });
      const j = await res.json();
      if (!res.ok) throw new Error(j.message || 'Processing failed');
      alert(j.message + '\nProcessed: ' + (j.processed ? j.processed.length : 0));
      loadCancellations();
    } catch (err) { alert('Error: '+err.message); }
  }

  if (e.target && e.target.id === 'process-refund-single') {
    const id = document.getElementById('process-refund-id').value;
    if (!id) return alert('Enter a refund ID to process');
    try {
      const res = await fetch(api('/api/admin/process-refunds'), {
        method: 'POST', headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+getAdminToken() },
        body: JSON.stringify({ refund_id: parseInt(id,10) })
      });
      const j = await res.json();
      if (!res.ok) throw new Error(j.message || 'Processing failed');
      alert(j.message);
      loadCancellations();
    } catch (err) { alert('Error: '+err.message); }
  }
});

/* ============================================================
   AUTO-LOGIN RESTORE
============================================================ */
(function init() {
  if (getAdminToken()) {
    document.getElementById('admin-login').classList.add('hidden');
    document.getElementById('admin-dashboard').classList.remove('hidden');
    document.getElementById('admin-logout').classList.remove('hidden');

    loadCarList();
    loadTransactions();
    ensureAdminExtras();
  }
})();
</script>
  <script src="/video-bg.js"></script>
</body>
</html>
